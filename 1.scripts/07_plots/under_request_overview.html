<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Overview of “data available upon request” statements in the PMC open access corpus</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="under_request_overview_files/libs/clipboard/clipboard.min.js"></script>
<script src="under_request_overview_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="under_request_overview_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="under_request_overview_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="under_request_overview_files/libs/quarto-html/popper.min.js"></script>
<script src="under_request_overview_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="under_request_overview_files/libs/quarto-html/anchor.min.js"></script>
<link href="under_request_overview_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="under_request_overview_files/libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="under_request_overview_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="under_request_overview_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="under_request_overview_files/libs/bootstrap/bootstrap-d6a003b94517c951b2d65075d42fb01b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Overview of “data available upon request” statements in the PMC open access corpus</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>This notebook documents the main descriptive analyses of “data available upon request” statements in a large corpus of PubMed Central (PMC) open access articles. It is intended as a fully reproducible supplement to the manuscript, and focuses on three questions:</p>
<ol type="1">
<li>How frequent are “upon request” statements across time and journals in the PMC Open Access subset?</li>
<li>Among these statements, which ones correspond to genuine data access routes (eg. patients, plasmids) versus vague or restrictive formulations (eg. raw data but not processed data)?</li>
<li>How have changes in data-sharing policies and methods-reporting standards shaped the use of “data available upon request” in the literature?</li>
</ol>
<p>All analyses are performed on a pre computed metadata table, <code>meta_under_request_tagged.tsv</code>, derived from the main text mining pipeline.</p>
<section id="fixing-the-classic-matplotlib-type-3-fonts-issue." class="level3">
<h3 class="anchored" data-anchor-id="fixing-the-classic-matplotlib-type-3-fonts-issue.">Fixing the classic Matplotlib “Type 3 fonts” issue.</h3>
<p>The fix is to force Matplotlib to embed TrueType fonts (Type 42) in PDFs.</p>
<div id="a014337c" class="cell" data-execution_count="370">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fixing the classic Matplotlib “Type 3 fonts” issue. The fix is to force Matplotlib to embed TrueType fonts (Type 42) in PDFs.</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib <span class="im">as</span> mpl</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> cycler <span class="im">import</span> cycler</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Use TrueType fonts in PDF/EPS so text is selectable and non-broken in Acrobat</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Make PDF text selectable as normal text (not one glyph per letter)</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>matplotlib.rcParams[<span class="st">"pdf.fonttype"</span>] <span class="op">=</span> <span class="dv">42</span>   <span class="co"># Use TrueType fonts in PDFs</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>matplotlib.rcParams[<span class="st">"ps.fonttype"</span>] <span class="op">=</span> <span class="dv">42</span>    <span class="co"># Same for EPS, just in case</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>matplotlib.rcParams[<span class="st">"text.usetex"</span>] <span class="op">=</span> <span class="va">False</span> <span class="co"># Ensure we are not using LaTeX rendering</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Font: journal style sans-serif</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>mpl.rcParams[<span class="st">"font.family"</span>] <span class="op">=</span> <span class="st">"sans-serif"</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>mpl.rcParams[<span class="st">"font.sans-serif"</span>] <span class="op">=</span> [<span class="st">"Arial"</span>, <span class="st">"Helvetica"</span>]</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co"># General sizes</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>mpl.rcParams[<span class="st">"font.size"</span>] <span class="op">=</span> <span class="dv">9</span>            <span class="co"># base</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>mpl.rcParams[<span class="st">"axes.titlesize"</span>] <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>mpl.rcParams[<span class="st">"axes.labelsize"</span>] <span class="op">=</span> <span class="dv">9</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>mpl.rcParams[<span class="st">"xtick.labelsize"</span>] <span class="op">=</span> <span class="dv">8</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>mpl.rcParams[<span class="st">"ytick.labelsize"</span>] <span class="op">=</span> <span class="dv">8</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>mpl.rcParams[<span class="st">"legend.fontsize"</span>] <span class="op">=</span> <span class="dv">8</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Figure quality</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>mpl.rcParams[<span class="st">"figure.dpi"</span>] <span class="op">=</span> <span class="dv">120</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>mpl.rcParams[<span class="st">"savefig.dpi"</span>] <span class="op">=</span> <span class="dv">300</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>mpl.rcParams[<span class="st">"figure.autolayout"</span>] <span class="op">=</span> <span class="va">False</span>  <span class="co"># we usually call tight_layout() manually</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Axes style</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>mpl.rcParams[<span class="st">"axes.linewidth"</span>] <span class="op">=</span> <span class="fl">0.8</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>mpl.rcParams[<span class="st">"axes.edgecolor"</span>] <span class="op">=</span> <span class="st">"black"</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>mpl.rcParams[<span class="st">"xtick.direction"</span>] <span class="op">=</span> <span class="st">"out"</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>mpl.rcParams[<span class="st">"ytick.direction"</span>] <span class="op">=</span> <span class="st">"out"</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>mpl.rcParams[<span class="st">"xtick.major.size"</span>] <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>mpl.rcParams[<span class="st">"ytick.major.size"</span>] <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>mpl.rcParams[<span class="st">"grid.linestyle"</span>] <span class="op">=</span> <span class="st">":"</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>mpl.rcParams[<span class="st">"grid.linewidth"</span>] <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Colorblind friendly qualitative palette (Okabe-Ito)</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>okabe_ito <span class="op">=</span> [</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#0072B2"</span>,  <span class="co"># blue</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#D55E00"</span>,  <span class="co"># vermillion (orange-ish)</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#009E73"</span>,  <span class="co"># bluish green</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#CC79A7"</span>,  <span class="co"># reddish purple</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#F0E442"</span>,  <span class="co"># yellow</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#56B4E9"</span>,  <span class="co"># sky blue</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#E69F00"</span>,  <span class="co"># orange</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#000000"</span>,  <span class="co"># black</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>tol_qualitative <span class="op">=</span> [</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#332288"</span>,  <span class="co"># dark blue</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#117733"</span>,  <span class="co"># dark green</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#44AA99"</span>,  <span class="co"># teal</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#88CCEE"</span>,  <span class="co"># light turquoise</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#DDCC77"</span>,  <span class="co"># sand</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#CC6677"</span>,  <span class="co"># rose</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#AA4499"</span>,  <span class="co"># purple</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#882255"</span>,  <span class="co"># wine</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>muted_scientific <span class="op">=</span> [</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#1b9e77"</span>,  <span class="co"># green</span></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#d95f02"</span>,  <span class="co"># orange</span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#7570b3"</span>,  <span class="co"># purple</span></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#e7298a"</span>,  <span class="co"># pink</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#66a61e"</span>,  <span class="co"># olive green</span></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#e6ab02"</span>,  <span class="co"># mustard</span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#a6761d"</span>,  <span class="co"># brown</span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#666666"</span>,  <span class="co"># gray</span></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a><span class="co">#mpl.rcParams["axes.prop_cycle"] = cycler(color=okabe_ito)</span></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a><span class="co">#mpl.rcParams["axes.prop_cycle"] = cycler(color=tol_qualitative)</span></span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>mpl.rcParams[<span class="st">"axes.prop_cycle"</span>] <span class="op">=</span> cycler(color<span class="op">=</span>muted_scientific)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="upstream-text-mining-pipeline-and-input-data" class="level2">
<h2 class="anchored" data-anchor-id="upstream-text-mining-pipeline-and-input-data">Upstream text mining pipeline and input data</h2>
<p>This notebook does not rerun the full text mining pipeline, but uses its outputs. The key upstream steps are:</p>
<ol type="1">
<li><p><strong>PMC and journal selection</strong><br>
We began from the PMC Open Access subset, restricted to a predefined set of journals and years. Metadata for all candidate articles were retrieved using <code>01_fetch_metadata_allpapers_monthly.py</code>, and filtered down to the PMC open access subset with <code>02_filter_openaccess_subset.py</code>.</p></li>
<li><p><strong>Full text download and XML quality control</strong><br>
Open access XML full texts were fetched from the PMC FTP and related endpoints (<code>03_download_papers_oai.py</code> and <code>03_download_papers_no_cc.py</code>). XML integrity was assessed with <code>04_validate_xml_integrity.py</code>, invalid XMLs were removed using <code>05_remove_invalid_xmls.sh</code>, and the metadata table was enriched with XML status flags via <code>06_enrich_tsv_xml_status.py</code>.</p></li>
<li><p><strong>Detection of “upon request” statements</strong><br>
Candidate “data available upon request” phrases were extracted from the JATS XML using <code>07_parse_under_request_with_sections_restricted.py</code>. This parser scans all sections and records, for each article, whether at least one phrase matches a curated phrase list, in which section(s) it occurs, and whether the phrase appears in context of restricted access keywords (for example, “data sharing agreement”, “patient privacy”, “controlled access”). <code>meta_under_request.tsv</code> is the output of the parser.</p></li>
<li><p><strong>Classification into genuine and restricted statements</strong><br>
The initial parse flags were refined by <code>08_tag_under_request_compliance.py</code>, which uses a set of deterministic rules and cue words to distinguish:</p>
<ul>
<li><strong>genuine “upon request” statements</strong>, where data or materials are actually intended to be shared (genuine == 1),</li>
<li>from <strong>restricted access statements</strong>, where access is limited by legal, ethical, or administrative constraints (restricted == 1),</li>
<li>and from <strong>ambiguous or non data related uses</strong> of the phrase (genuine == 0 and restricted == 0).</li>
</ul></li>
</ol>
<p>The output of these steps is the metadata table <code>meta_under_request_tagged.tsv</code>, which is the sole input used in this notebook. Each row corresponds to one PMC article and contains, among others, the columns:</p>
<ul>
<li><code>journal</code><br>
</li>
<li><code>pub_year</code><br>
</li>
<li><code>ok_analysis</code> (1 if the article passed all XML checks and could be analysed)<br>
</li>
<li><code>under_request</code> (final binary flag for presence of at least one “upon request” statement)<br>
</li>
<li><code>genuine</code> (1 if the statement is judged to be a genuine data sharing route)<br>
</li>
<li><code>restricted_initial_parse</code>, <code>restricted</code> (initial parser flag and final restricted flag)<br>
</li>
<li><code>section_under_request</code> and <code>phrase</code> (section and literal matched phrase).</li>
</ul>
<section id="loading-the-tsv-files-and-params" class="level3">
<h3 class="anchored" data-anchor-id="loading-the-tsv-files-and-params">Loading the TSV files and params</h3>
<ul>
<li>Some basic plotting defaults</li>
<li>Years to display</li>
<li>Data dirs and files</li>
<li>Output folders</li>
</ul>
<div id="4abdfb3f" class="cell" data-tags="[&quot;hide_input&quot;]" data-execution_count="371">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Some basic plotting defaults</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>matplotlib.rcParams[<span class="st">"font.size"</span>] <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Years to display</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>YEAR_MIN, YEAR_MAX <span class="op">=</span> <span class="dv">2010</span>, <span class="dv">2025</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co"># This notebook lives in 1.scripts/07_plots</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>notebook_dir <span class="op">=</span> Path.cwd()</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Notebook dir:"</span>, notebook_dir)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Project root is one level above 1.scripts</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>project_root <span class="op">=</span> notebook_dir.parents[<span class="dv">1</span>]</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Project root:"</span>, project_root)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>data_dir <span class="op">=</span> project_root <span class="op">/</span> <span class="st">"2.data"</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>out_root <span class="op">=</span> project_root <span class="op">/</span> <span class="st">"4.analyses"</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Output folders</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>out_papers <span class="op">=</span> out_root <span class="op">/</span> <span class="st">"papers_by_year"</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>out_upon <span class="op">=</span> out_root <span class="op">/</span> <span class="st">"upon_request"</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> [</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    out_papers,</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    out_upon <span class="op">/</span> <span class="st">"under_request"</span>,</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    out_upon <span class="op">/</span> <span class="st">"under_request_pct"</span>,</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    out_upon <span class="op">/</span> <span class="st">"under_request_pct_by_journal"</span>,</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>]:</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    p.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>input_path <span class="op">=</span> data_dir <span class="op">/</span> <span class="st">"meta_under_request_tagged.tsv"</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>timeline_path <span class="op">=</span> data_dir <span class="op">/</span> <span class="st">"policy_timeline.tsv"</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Input TSV:"</span>, input_path)</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Policy timeline exists:"</span>, timeline_path.exists())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Notebook dir: /Users/benoit/work/under_request/1.scripts/07_plots
Project root: /Users/benoit/work/under_request
Input TSV: /Users/benoit/work/under_request/2.data/meta_under_request_tagged.tsv
Policy timeline exists: True</code></pre>
</div>
</div>
</section>
</section>
<section id="analysis-subset-and-definitions-of-under-request-flags" class="level2">
<h2 class="anchored" data-anchor-id="analysis-subset-and-definitions-of-under-request-flags">Analysis subset and definitions of “under request” flags</h2>
<p>For the descriptive plots in this notebook we restrict to articles with <code>ok_analysis == 1</code>. These are articles for which:</p>
<ul>
<li>a valid XML full text was available,</li>
<li>the XML passed basic integrity checks,</li>
<li>and the “upon request” parser could be applied without errors.</li>
</ul>
<p>Within this subset, we use three key binary variables derived from <code>08_tag_under_request_compliance.py</code>:</p>
<ul>
<li><p><code>under_request</code><br>
Final indicator that the article contains at least one “data available upon request” statement in the full text. The parser looks for a curated set of phrase variants (for example, “data are available from the corresponding author upon reasonable request”) across all sections.</p></li>
<li><p><code>genuine</code><br>
Indicator that the “upon request” statement is judged to be a <strong>genuine data access route</strong>. This includes cases where:</p>
<ul>
<li>data are primarily archived in public repositories, and “upon request” is used as an additional route, or</li>
<li>specific materials (for example, plasmids, strains, custom code, blueprints) are made available upon request. Vague, badly specified, or clearly non data related uses of “upon request” are not labelled as genuine.</li>
</ul></li>
<li><p><code>restricted</code><br>
Indicator that the “upon request” statement reflects a <strong>restricted sharing regime</strong>. This is a strict subset of <code>genuine == 1</code> and includes phrases that mention:</p>
<ul>
<li>formal data sharing agreements or non disclosure agreements,</li>
<li>regulatory constraints (for example “patient level data available upon request, subject to approval by the sponsor and regulatory authorities”),</li>
<li>hospital or registry restrictions, or security concerns for human genetic resources.</li>
</ul></li>
</ul>
<p>By construction:</p>
<ul>
<li><code>under_request == 0</code> includes all papers without a detected “upon request” phrase.<br>
</li>
<li>Among <code>under_request == 1</code>, papers are further split into:
<ul>
<li>genuine only: <code>genuine == 1</code> and <code>restricted == 0</code>,<br>
</li>
<li>restricted: <code>restricted == 1</code> (which implies <code>genuine == 1</code> by definition),<br>
</li>
<li>and non genuine statements: <code>genuine == 0</code> and <code>restricted == 0</code>.</li>
</ul></li>
</ul>
<p>All plots in this notebook either compare <code>under_request == 1</code> versus <code>under_request == 0</code>, or subdivide the <code>under_request == 1</code> subset into genuine and restricted categories.</p>
<section id="tsv" class="level3">
<h3 class="anchored" data-anchor-id="tsv">TSV</h3>
<div id="1d35bdc4" class="cell" data-execution_count="372">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Output folder</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>out_dir_donut <span class="op">=</span> out_upon <span class="op">/</span> <span class="st">"under_request_donut_pie_bar"</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>out_dir_donut.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Work on ok_analysis == 1</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>df_ok <span class="op">=</span> df_g[df_g[<span class="st">"ok_analysis_num"</span>] <span class="op">==</span> <span class="dv">1</span>].copy()</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>total_ok <span class="op">=</span> <span class="bu">len</span>(df_ok)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>n_ur1 <span class="op">=</span> <span class="bu">int</span>((df_ok[<span class="st">"under_request_num"</span>] <span class="op">==</span> <span class="dv">1</span>).<span class="bu">sum</span>())</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>n_ur0 <span class="op">=</span> total_ok <span class="op">-</span> n_ur1</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>pct_ur1 <span class="op">=</span> <span class="fl">100.0</span> <span class="op">*</span> n_ur1 <span class="op">/</span> total_ok <span class="cf">if</span> total_ok <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>pct_ur0 <span class="op">=</span> <span class="fl">100.0</span> <span class="op">*</span> n_ur0 <span class="op">/</span> total_ok <span class="cf">if</span> total_ok <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total ok_analysis == 1: </span><span class="sc">{</span>total_ok<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"UR == 0: </span><span class="sc">{</span>n_ur0<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>pct_ur0<span class="sc">:.1f}</span><span class="ss">%)"</span>)</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"UR == 1: </span><span class="sc">{</span>n_ur1<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>pct_ur1<span class="sc">:.1f}</span><span class="ss">%)"</span>)</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Build summary table</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>summary_global <span class="op">=</span> (</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    pd.DataFrame(</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>            <span class="st">"category"</span>: [<span class="st">"not_UR"</span>, <span class="st">"UR"</span>],</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>            <span class="st">"n"</span>: [n_ur0, n_ur1],</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>            <span class="st">"pct"</span>: [pct_ur0, pct_ur1],</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>summary_global.to_csv(</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    out_dir_donut <span class="op">/</span> <span class="st">"under_request_global_counts.tsv"</span>,</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    sep<span class="op">=</span><span class="st">"</span><span class="ch">\t</span><span class="st">"</span>,</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>summary_global</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Total ok_analysis == 1: 123211
UR == 0: 103020 (83.6%)
UR == 1: 20191 (16.4%)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="372">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">category</th>
<th data-quarto-table-cell-role="th">n</th>
<th data-quarto-table-cell-role="th">pct</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>not_UR</td>
<td>103020</td>
<td>83.612664</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>UR</td>
<td>20191</td>
<td>16.387336</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
</section>
<section id="global-prevalence-of-data-available-upon-request" class="level2">
<h2 class="anchored" data-anchor-id="global-prevalence-of-data-available-upon-request">1. Global prevalence of “data available upon request”</h2>
<p>We first summarise how frequent “upon request” statements are in the analysis corpus. Using all articles with <code>ok_analysis == 1</code>, we compute:</p>
<ul>
<li>the total number of articles,</li>
<li>the number and percentage of articles with <code>under_request == 1</code>,</li>
<li>and the complementary number and percentage with <code>under_request == 0</code>.</li>
</ul>
<p>We visualise this with:</p>
<ul>
<li>a single 100 percent stacked bar,<br>
</li>
<li>a pie chart,<br>
</li>
<li>and a donut chart.</li>
</ul>
<p>These plots provide a high level view of how common “data available upon request” language is in the open access literature under study.</p>
<section id="donut-plot-all-papers-ur-2010-2015" class="level3">
<h3 class="anchored" data-anchor-id="donut-plot-all-papers-ur-2010-2015">Donut plot : all papers UR 2010-2015</h3>
<div id="8275cb1c" class="cell" data-execution_count="373">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># donut</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> summary_global[<span class="st">"category"</span>].values  <span class="co"># ["not_UR", "UR"]</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>values <span class="op">=</span> summary_global[<span class="st">"n"</span>].values</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>pct_values <span class="op">=</span> summary_global[<span class="st">"pct"</span>].values</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>total_ok <span class="op">=</span> <span class="bu">int</span>(values.<span class="bu">sum</span>())</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>pct_ur1 <span class="op">=</span> <span class="bu">float</span>(pct_values[labels.tolist().index(<span class="st">"UR"</span>)]) <span class="cf">if</span> <span class="st">"UR"</span> <span class="kw">in</span> labels <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">4</span>))</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>wedges, _ <span class="op">=</span> ax.pie(</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    values,</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    labels<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    colors<span class="op">=</span>[<span class="st">"C0"</span>, <span class="st">"C1"</span>],</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    startangle<span class="op">=</span><span class="dv">90</span>,</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    counterclock<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    wedgeprops<span class="op">=</span><span class="bu">dict</span>(width<span class="op">=</span><span class="fl">0.3</span>),</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Center text: total and UR share</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>ax.text(</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>,</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>,</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"n=</span><span class="sc">{</span>total_ok<span class="sc">}</span><span class="ch">\n</span><span class="ss">UR=</span><span class="sc">{</span>pct_ur1<span class="sc">:.1f}</span><span class="ss">%"</span>,</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    ha<span class="op">=</span><span class="st">"center"</span>,</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    va<span class="op">=</span><span class="st">"center"</span>,</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    fontsize<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Legend with correct category names</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>legend_labels <span class="op">=</span> [</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"</span><span class="sc">{</span>lab<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>val<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>pct<span class="sc">:.1f}</span><span class="ss">%)"</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> lab, val, pct <span class="kw">in</span> <span class="bu">zip</span>(labels, values, pct_values)</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>ax.legend(</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    wedges,</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>    legend_labels,</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>    loc<span class="op">=</span><span class="st">"center left"</span>,</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>    bbox_to_anchor<span class="op">=</span>(<span class="fl">1.0</span>, <span class="fl">0.5</span>),</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>    frameon<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Category"</span>,</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>title_years <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>YEAR_MIN<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>YEAR_MAX<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="ss">f"All papers (ok_analysis == 1, </span><span class="sc">{</span>title_years<span class="sc">}</span><span class="ss">)</span><span class="ch">\n</span><span class="ss">UR vs not_UR"</span>)</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>fig.savefig(out_dir_donut <span class="op">/</span> <span class="st">"under_request_global_donut.png"</span>, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>fig.savefig(out_dir_donut <span class="op">/</span> <span class="st">"under_request_global_donut.pdf"</span>)</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>plt.close(fig)</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>fig</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="373">
<div>
<figure class="figure">
<p><img src="under_request_overview_files/figure-html/cell-5-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Across all ok_analysis == 1 articles (n = 123 211), 20 191 papers (16.4 %) contain at least one “under request” statement, while 83.6 % do not.</p>
</section>
<section id="piechart-plot-all-papers-ur-2010-2015" class="level3">
<h3 class="anchored" data-anchor-id="piechart-plot-all-papers-ur-2010-2015">Piechart plot : all papers UR 2010-2015</h3>
<div id="e5981362" class="cell" data-execution_count="374">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># piechart</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> summary_global[<span class="st">"category"</span>].values  <span class="co"># ["not_UR", "UR"]</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>values <span class="op">=</span> summary_global[<span class="st">"n"</span>].values</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>pct_values <span class="op">=</span> summary_global[<span class="st">"pct"</span>].values</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">4</span>))</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Slice labels printed directly on the wedges</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>wedge_labels <span class="op">=</span> [</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"</span><span class="sc">{</span>lab<span class="sc">}</span><span class="ch">\n</span><span class="sc">{</span>val<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>pct<span class="sc">:.1f}</span><span class="ss">%)"</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> lab, val, pct <span class="kw">in</span> <span class="bu">zip</span>(labels, values, pct_values)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>ax.pie(</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    values,</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    labels<span class="op">=</span>wedge_labels,</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    colors<span class="op">=</span>[<span class="st">"C0"</span>, <span class="st">"C1"</span>],</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    startangle<span class="op">=</span><span class="dv">90</span>,</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    counterclock<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>title_years <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>YEAR_MIN<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>YEAR_MAX<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="ss">f"All papers (ok_analysis == 1, </span><span class="sc">{</span>title_years<span class="sc">}</span><span class="ss">)</span><span class="ch">\n</span><span class="ss">UR vs not_UR"</span>)</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>fig.savefig(out_dir_donut <span class="op">/</span> <span class="st">"under_request_global_pie.png"</span>, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>fig.savefig(out_dir_donut <span class="op">/</span> <span class="st">"under_request_global_pie.pdf"</span>)</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>plt.close(fig)</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>fig</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="374">
<div>
<figure class="figure">
<p><img src="under_request_overview_files/figure-html/cell-6-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Across all ok_analysis == 1 articles (n = 123 211), 20 191 papers (16.4 %) contain at least one “under request” statement, while 83.6 % do not.</p>
</section>
<section id="barplot-all-papers-ur-2010-2015" class="level3">
<h3 class="anchored" data-anchor-id="barplot-all-papers-ur-2010-2015">Barplot : all papers UR 2010-2015</h3>
<div id="fb0fbee6" class="cell" data-execution_count="375">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Barplot</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> summary_global[<span class="st">"category"</span>].values</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>values <span class="op">=</span> summary_global[<span class="st">"n"</span>].values</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>pct_values <span class="op">=</span> summary_global[<span class="st">"pct"</span>].values</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">4</span>))</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.arange(<span class="bu">len</span>(labels))</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>bars <span class="op">=</span> ax.bar(x, values, color<span class="op">=</span>[<span class="st">"C0"</span>, <span class="st">"C1"</span>])</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>ax.set_xticks(x)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>ax.set_xticklabels(labels)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Number of papers"</span>)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="co">#ax.set_title("All papers (ok_analysis == 1)\nwith and without 'under request'")</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>title_years <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>YEAR_MIN<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>YEAR_MAX<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="ss">f"All papers (ok_analysis == 1, </span><span class="sc">{</span>title_years<span class="sc">}</span><span class="ss">)</span><span class="ch">\n</span><span class="ss">UR vs not_UR"</span>)</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(<span class="dv">0</span>, <span class="bu">max</span>(values) <span class="op">*</span> <span class="fl">1.15</span>)</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Annotate bars with n and %</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, bar <span class="kw">in</span> <span class="bu">enumerate</span>(bars):</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    height <span class="op">=</span> bar.get_height()</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    ax.text(</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>        bar.get_x() <span class="op">+</span> bar.get_width() <span class="op">/</span> <span class="dv">2</span>,</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>        height,</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>values[i]<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>pct_values[i]<span class="sc">:.1f}</span><span class="ss">%)"</span>,</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>        ha<span class="op">=</span><span class="st">"center"</span>,</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>        va<span class="op">=</span><span class="st">"bottom"</span>,</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>        fontsize<span class="op">=</span><span class="dv">9</span>,</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>fig.savefig(out_dir_donut <span class="op">/</span> <span class="st">"under_request_global_bar.png"</span>, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>fig.savefig(out_dir_donut <span class="op">/</span> <span class="st">"under_request_global_bar.pdf"</span>)</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>plt.close(fig)</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>fig</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="375">
<div>
<figure class="figure">
<p><img src="under_request_overview_files/figure-html/cell-7-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Across all ok_analysis == 1 articles (n = 123 211), 20 191 papers (16.4 %) contain at least one “under request” statement, while 83.6 % do not.</p>
</section>
</section>
<section id="time-trends-in-under-request-statements" class="level2">
<h2 class="anchored" data-anchor-id="time-trends-in-under-request-statements">2. Time trends in “under request” statements</h2>
<p>To examine how “upon request” statements have evolved over time, we collapse the data by publication year and calculate, for each year:</p>
<ul>
<li>the total number of analysable articles (<code>ok_analysis == 1</code>),</li>
<li>the number with <code>under_request == 1</code>,</li>
<li>and the corresponding percentage of “under request” articles.</li>
</ul>
<p>We then produce:</p>
<ul>
<li>line plots of the absolute number of “under request” articles per year,</li>
<li>stacked barplots showing the proportion of articles with and without “under request” statements by year.</li>
</ul>
<p>These figures allow us to see whether “upon request” language was more prevalent in earlier years and how it changes around key policy milestones, for example journal data policies or the introduction of stronger open data requirements.</p>
<section id="plotting-the-under-request-by-years" class="level3">
<h3 class="anchored" data-anchor-id="plotting-the-under-request-by-years">Plotting the under request by years</h3>
<div id="61fdcc7a" class="cell" data-execution_count="376">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cell 2 – Load data and policy timeline</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Load main table</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(input_path, sep<span class="op">=</span><span class="st">"</span><span class="ch">\t</span><span class="st">"</span>, dtype<span class="op">=</span><span class="bu">str</span>, keep_default_na<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">"year"</span> <span class="kw">not</span> <span class="kw">in</span> df.columns:</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Expected a 'year' column in meta_under_request_tagged.tsv"</span>)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"year"</span>] <span class="op">=</span> pd.to_numeric(df[<span class="st">"year"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co"># ok_analysis column may have different names</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>ok_col <span class="op">=</span> <span class="st">"ok_analysis"</span> <span class="cf">if</span> <span class="st">"ok_analysis"</span> <span class="kw">in</span> df.columns <span class="cf">else</span> (</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"analysis_ok"</span> <span class="cf">if</span> <span class="st">"analysis_ok"</span> <span class="kw">in</span> df.columns <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> ok_col <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"ok_analysis_num"</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"ok_analysis_num"</span>] <span class="op">=</span> (</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>        pd.to_numeric(df[ok_col], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>        .fillna(<span class="dv">0</span>)</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>        .astype(<span class="bu">int</span>)</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a><span class="co"># under_request flag</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">"under_request"</span> <span class="kw">in</span> df.columns:</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"under_request_num"</span>] <span class="op">=</span> (</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>        pd.to_numeric(df[<span class="st">"under_request"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>        .fillna(<span class="dv">0</span>)</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>        .astype(<span class="bu">int</span>)</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"under_request_num"</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Restrict to valid years in our window</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.dropna(subset<span class="op">=</span>[<span class="st">"year"</span>]).copy()</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"year"</span>] <span class="op">=</span> df[<span class="st">"year"</span>].astype(<span class="bu">int</span>)</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[(df[<span class="st">"year"</span>] <span class="op">&gt;=</span> YEAR_MIN) <span class="op">&amp;</span> (df[<span class="st">"year"</span>] <span class="op">&lt;=</span> YEAR_MAX)].copy()</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>df.head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="376">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">pmid</th>
<th data-quarto-table-cell-role="th">pmcid</th>
<th data-quarto-table-cell-role="th">OA</th>
<th data-quarto-table-cell-role="th">OA_subset</th>
<th data-quarto-table-cell-role="th">journal</th>
<th data-quarto-table-cell-role="th">pub_date</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">PublicationType</th>
<th data-quarto-table-cell-role="th">ok_analysis</th>
<th data-quarto-table-cell-role="th">DOI</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">matching</th>
<th data-quarto-table-cell-role="th">phrase</th>
<th data-quarto-table-cell-role="th">section</th>
<th data-quarto-table-cell-role="th">restricted_initial_parse</th>
<th data-quarto-table-cell-role="th">domain</th>
<th data-quarto-table-cell-role="th">reason</th>
<th data-quarto-table-cell-role="th">genuine</th>
<th data-quarto-table-cell-role="th">restricted</th>
<th data-quarto-table-cell-role="th">ok_analysis_num</th>
<th data-quarto-table-cell-role="th">under_request_num</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>19966787</td>
<td>2999963</td>
<td>1</td>
<td>1</td>
<td>Nature</td>
<td>14/01/2010</td>
<td>2010</td>
<td>Journal Article</td>
<td>1</td>
<td>10.1038/nature08678</td>
<td>...</td>
<td></td>
<td></td>
<td></td>
<td>0</td>
<td>none</td>
<td>none</td>
<td></td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>20016488</td>
<td>2880489</td>
<td>1</td>
<td>1</td>
<td>Nature</td>
<td>14/01/2010</td>
<td>2010</td>
<td>Journal Article</td>
<td>1</td>
<td>10.1038/nature08629</td>
<td>...</td>
<td></td>
<td></td>
<td></td>
<td>0</td>
<td>none</td>
<td>none</td>
<td></td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>20023628</td>
<td>2811870</td>
<td>1</td>
<td>1</td>
<td>Nature</td>
<td>07/01/2010</td>
<td>2010</td>
<td>Journal Article</td>
<td>1</td>
<td>10.1038/nature08648</td>
<td>...</td>
<td></td>
<td></td>
<td></td>
<td>0</td>
<td>none</td>
<td>none</td>
<td></td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>20032975</td>
<td>4011561</td>
<td>1</td>
<td>1</td>
<td>Nature</td>
<td>21/01/2010</td>
<td>2010</td>
<td>Journal Article</td>
<td>1</td>
<td>10.1038/nature08712</td>
<td>...</td>
<td></td>
<td></td>
<td></td>
<td>0</td>
<td>none</td>
<td>none</td>
<td></td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>20054295</td>
<td>2894702</td>
<td>1</td>
<td>1</td>
<td>Nature</td>
<td>04/02/2010</td>
<td>2010</td>
<td>Journal Article</td>
<td>1</td>
<td>10.1038/nature08725</td>
<td>...</td>
<td></td>
<td></td>
<td></td>
<td>0</td>
<td>none</td>
<td>none</td>
<td></td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
</tbody>
</table>

<p>5 rows × 28 columns</p>
</div>
</div>
</div>
<div id="5258133e" class="cell" data-execution_count="377">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Optionally load the policy timeline and a helper to overlay vertical lines:</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Load policy timeline if present</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> timeline_path.exists():</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    timeline <span class="op">=</span> pd.read_csv(timeline_path, sep<span class="op">=</span><span class="st">"</span><span class="ch">\t</span><span class="st">"</span>, dtype<span class="op">=</span><span class="bu">str</span>, keep_default_na<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    timeline[<span class="st">"year"</span>] <span class="op">=</span> pd.to_numeric(timeline[<span class="st">"year"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    timeline <span class="op">=</span> timeline.dropna(subset<span class="op">=</span>[<span class="st">"year"</span>])</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    timeline <span class="op">=</span> <span class="va">None</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> overlay_policy_lines(ax, timeline_df):</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Draw vertical policy lines given a timeline table with a 'year' column."""</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> timeline_df <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> timeline_df.empty:</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    ymin, ymax <span class="op">=</span> ax.get_ylim()</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> timeline_df.iterrows():</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>        yr <span class="op">=</span> row[<span class="st">"year"</span>]</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>        ax.axvline(yr, color<span class="op">=</span><span class="st">"gray"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, linewidth<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>        ax.text(</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>            yr <span class="op">+</span> <span class="fl">0.05</span>,</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>            ymax <span class="op">*</span> <span class="fl">0.98</span>,</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>            <span class="bu">str</span>(<span class="bu">int</span>(yr)),</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>            rotation<span class="op">=</span><span class="dv">90</span>,</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>            va<span class="op">=</span><span class="st">"top"</span>,</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>            ha<span class="op">=</span><span class="st">"left"</span>,</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>            fontsize<span class="op">=</span><span class="dv">8</span>,</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span><span class="st">"gray"</span>,</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>timeline.head() <span class="cf">if</span> timeline <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">else</span> <span class="st">"No policy timeline loaded"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="377">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">publisher</th>
<th data-quarto-table-cell-role="th">journal_scope</th>
<th data-quarto-table-cell-role="th">policy</th>
<th data-quarto-table-cell-role="th">notes</th>
<th data-quarto-table-cell-role="th">url</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2014</td>
<td>PLOS</td>
<td>All PLOS journals</td>
<td>Data Availability Statements required</td>
<td>Portfolio-wide policy starting March 2014; dat...</td>
<td>https://journals.plos.org/plosone/s/data-avail...</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2016</td>
<td>Cell Press</td>
<td>Cell + life-science titles</td>
<td>STAR Methods introduced</td>
<td>Structured, Transparent, Accessible Reporting;...</td>
<td>https://www.cell.com/star-methods</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2016</td>
<td>Nature Portfolio</td>
<td>Nature (flagship) + initial pilot journals</td>
<td>Mandatory Data Availability Statements (pilot/...</td>
<td>DAS piloted at 5 journals (Mar 2016) and adopt...</td>
<td></td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2017</td>
<td>Nature Portfolio</td>
<td>Nature Research journals</td>
<td>Mandatory Data Availability Statements (rollout)</td>
<td>Rollout across the portfolio after 2016 pilot/...</td>
<td></td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>2010</td>
<td>AAAS</td>
<td>Science (policy long-standing)</td>
<td>Data &amp; materials availability required</td>
<td>Policy predates 2016–2017; specify article-typ...</td>
<td>https://www.science.org/content/page/science-j...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
</section>
<section id="differences-between-journals" class="level2">
<h2 class="anchored" data-anchor-id="differences-between-journals">3. Differences between journals</h2>
<p>Next, we quantify how the use of “data available upon request” varies between journals. For each journal in the corpus, we compute:</p>
<ul>
<li>the number of analysable articles (<code>ok_analysis == 1</code>),</li>
<li>the number with <code>under_request == 1</code>,</li>
<li>and the percentage of “under request” articles.</li>
</ul>
<p>We display these results as:</p>
<ul>
<li>a barplot of the percentage of “under request” articles per journal,<br>
</li>
<li>and corresponding barplots in absolute counts.</li>
</ul>
<p>Journals are sorted by the percentage of “under request” articles to facilitate comparisons. These plots highlight journals that have historically relied heavily on “upon request” formulations versus those where such statements are rare.</p>
<div id="6746844b" class="cell" data-execution_count="378">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cell 3 – P1: Papers by year (total vs used in analysis)</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This reproduces the “papers by year” plot and writes a TSV + PNG + PDF in 4.analyses/papers_by_year/.</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>years <span class="op">=</span> pd.Series(<span class="bu">range</span>(YEAR_MIN, YEAR_MAX <span class="op">+</span> <span class="dv">1</span>), name<span class="op">=</span><span class="st">"year"</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co"># total per year</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>total <span class="op">=</span> df.groupby(<span class="st">"year"</span>).size().rename(<span class="st">"n_total"</span>)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co"># ok_analysis == 1 per year</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>ok1 <span class="op">=</span> df[df[<span class="st">"ok_analysis_num"</span>] <span class="op">==</span> <span class="dv">1</span>].groupby(<span class="st">"year"</span>).size().rename(<span class="st">"n_ok"</span>)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>summary_p1 <span class="op">=</span> (</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    pd.DataFrame({<span class="st">"year"</span>: years})</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    .merge(total.reset_index(), on<span class="op">=</span><span class="st">"year"</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    .merge(ok1.reset_index(), on<span class="op">=</span><span class="st">"year"</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>summary_p1[<span class="st">"n_total"</span>] <span class="op">=</span> summary_p1[<span class="st">"n_total"</span>].fillna(<span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>summary_p1[<span class="st">"n_ok"</span>] <span class="op">=</span> summary_p1[<span class="st">"n_ok"</span>].fillna(<span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>summary_p1[<span class="st">"n_not_ok"</span>] <span class="op">=</span> (summary_p1[<span class="st">"n_total"</span>] <span class="op">-</span> summary_p1[<span class="st">"n_ok"</span>]).clip(lower<span class="op">=</span><span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Save TSV</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>summary_p1.to_csv(out_papers <span class="op">/</span> <span class="st">"papers_by_year.tsv"</span>, sep<span class="op">=</span><span class="st">"</span><span class="ch">\t</span><span class="st">"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>summary_p1.head()</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot (stacked):</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>))</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> summary_p1[<span class="st">"year"</span>]</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> summary_p1[<span class="st">"n_not_ok"</span>]</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>top <span class="op">=</span> summary_p1[<span class="st">"n_ok"</span>]</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>ax.bar(x, base, label<span class="op">=</span><span class="st">"ok_analysis == 0"</span>)</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>ax.bar(x, top, bottom<span class="op">=</span>base, label<span class="op">=</span><span class="st">"ok_analysis == 1"</span>)</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Year"</span>)</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Number of papers"</span>)</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Papers by year and inclusion in analysis"</span>)</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>ax.set_xticks(x)</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>ax.set_xticklabels(x, rotation<span class="op">=</span><span class="dv">90</span>)</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>overlay_policy_lines(ax, timeline)</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>ax.legend(frameon<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>fig.savefig(out_papers <span class="op">/</span> <span class="st">"papers_by_year.png"</span>, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>fig.savefig(out_papers <span class="op">/</span> <span class="st">"papers_by_year.pdf"</span>)</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>fig</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="378">
<div>
<figure class="figure">
<p><img src="under_request_overview_files/figure-html/cell-10-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="under_request_overview_files/figure-html/cell-10-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="number-of-upon-request-papers-per-year" class="level3">
<h3 class="anchored" data-anchor-id="number-of-upon-request-papers-per-year">Number of Upon Request papers per year</h3>
<p>This plot the number of papers having an UR (or not) mention in the text. Also showing the different policy timelines.</p>
<div id="c34b42d6" class="cell" data-execution_count="379">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cell 4 – P2: Among ok_analysis == 1, under_request counts per year</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Outputs TSV + PNG + PDF in 4.analyses/upon_request/under_request/.</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>df_ok <span class="op">=</span> df[df[<span class="st">"ok_analysis_num"</span>] <span class="op">==</span> <span class="dv">1</span>].copy()</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>counts <span class="op">=</span> (</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    df_ok.groupby([<span class="st">"year"</span>, <span class="st">"under_request_num"</span>])</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>         .size()</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>         .reset_index(name<span class="op">=</span><span class="st">"n"</span>)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Pivot to get columns not_ur and ur</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>pivot_counts <span class="op">=</span> (</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    counts</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    .pivot(index<span class="op">=</span><span class="st">"year"</span>, columns<span class="op">=</span><span class="st">"under_request_num"</span>, values<span class="op">=</span><span class="st">"n"</span>)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    .fillna(<span class="dv">0</span>)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="dv">0</span>: <span class="st">"not_ur"</span>, <span class="dv">1</span>: <span class="st">"ur"</span>})</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure all years in range are present</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>years_df <span class="op">=</span> pd.DataFrame({<span class="st">"year"</span>: <span class="bu">range</span>(YEAR_MIN, YEAR_MAX <span class="op">+</span> <span class="dv">1</span>)})</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>pivot_counts <span class="op">=</span> years_df.merge(pivot_counts, on<span class="op">=</span><span class="st">"year"</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>pivot_counts[[<span class="st">"not_ur"</span>, <span class="st">"ur"</span>]] <span class="op">=</span> pivot_counts[[<span class="st">"not_ur"</span>, <span class="st">"ur"</span>]].fillna(<span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>pivot_counts.to_csv(</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    out_upon <span class="op">/</span> <span class="st">"under_request"</span> <span class="op">/</span> <span class="st">"under_request.tsv"</span>,</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    sep<span class="op">=</span><span class="st">"</span><span class="ch">\t</span><span class="st">"</span>,</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>pivot_counts.head()</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>))</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> pivot_counts[<span class="st">"year"</span>]</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> pivot_counts[<span class="st">"not_ur"</span>]</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>top <span class="op">=</span> pivot_counts[<span class="st">"ur"</span>]</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>ax.bar(x, base, label<span class="op">=</span><span class="st">"under_request == 0"</span>)</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>ax.bar(x, top, bottom<span class="op">=</span>base, label<span class="op">=</span><span class="st">"under_request == 1"</span>)</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Year"</span>)</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Number of papers (ok_analysis == 1)"</span>)</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"‘Upon request’ among papers used in analysis (counts per year)"</span>)</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>ax.set_xticks(x)</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>ax.set_xticklabels(x, rotation<span class="op">=</span><span class="dv">90</span>)</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>overlay_policy_lines(ax, timeline)</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>ax.legend(frameon<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>fig.savefig(</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>    out_upon <span class="op">/</span> <span class="st">"under_request"</span> <span class="op">/</span> <span class="st">"under_request.png"</span>,</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>    dpi<span class="op">=</span><span class="dv">300</span>,</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>fig.savefig(</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>    out_upon <span class="op">/</span> <span class="st">"under_request"</span> <span class="op">/</span> <span class="st">"under_request.pdf"</span>,</span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>fig</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="379">
<div>
<figure class="figure">
<p><img src="under_request_overview_files/figure-html/cell-11-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="under_request_overview_files/figure-html/cell-11-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Journals differ markedly in their reliance on “upon request” language. For example, approximately 36 % of analysable Nature Communications articles contain a UR statement, versus less than 5 % in Genome Research</p>
<div id="828be475" class="cell" data-execution_count="380">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cell 5 – P3: Among ok_analysis == 1, under_request percent per year</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Outputs TSV + PNG + PDF in 4.analyses/upon_request/under_request_pct/.</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>summary_pct <span class="op">=</span> pivot_counts.copy()</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>total <span class="op">=</span> summary_pct[<span class="st">"not_ur"</span>] <span class="op">+</span> summary_pct[<span class="st">"ur"</span>]</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>summary_pct[<span class="st">"not_ur_pct"</span>] <span class="op">=</span> <span class="fl">100.0</span> <span class="op">*</span> summary_pct[<span class="st">"not_ur"</span>] <span class="op">/</span> total.replace(<span class="dv">0</span>, np.nan)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>summary_pct[<span class="st">"ur_pct"</span>] <span class="op">=</span> <span class="fl">100.0</span> <span class="op">*</span> summary_pct[<span class="st">"ur"</span>] <span class="op">/</span> total.replace(<span class="dv">0</span>, np.nan)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>summary_pct.to_csv(</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    out_upon <span class="op">/</span> <span class="st">"under_request_pct"</span> <span class="op">/</span> <span class="st">"under_request_pct.tsv"</span>,</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    sep<span class="op">=</span><span class="st">"</span><span class="ch">\t</span><span class="st">"</span>,</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>summary_pct.head()</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>))</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> summary_pct[<span class="st">"year"</span>]</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> summary_pct[<span class="st">"not_ur_pct"</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>top <span class="op">=</span> summary_pct[<span class="st">"ur_pct"</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>ax.bar(x, base, label<span class="op">=</span><span class="st">"under_request == 0"</span>)</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>ax.bar(x, top, bottom<span class="op">=</span>base, label<span class="op">=</span><span class="st">"under_request == 1"</span>)</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Year"</span>)</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Percent of ok_analysis == 1"</span>)</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"‘Upon request’ among papers used in analysis (percent per year)"</span>)</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>ax.set_xticks(x)</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>ax.set_xticklabels(x, rotation<span class="op">=</span><span class="dv">90</span>)</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(<span class="dv">0</span>, <span class="dv">100</span>)</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>overlay_policy_lines(ax, timeline)</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>ax.legend(frameon<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>fig.savefig(</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>    out_upon <span class="op">/</span> <span class="st">"under_request_pct"</span> <span class="op">/</span> <span class="st">"under_request_pct.png"</span>,</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>    dpi<span class="op">=</span><span class="dv">300</span>,</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>fig.savefig(</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>    out_upon <span class="op">/</span> <span class="st">"under_request_pct"</span> <span class="op">/</span> <span class="st">"under_request_pct.pdf"</span>,</span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>fig</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="380">
<div>
<figure class="figure">
<p><img src="under_request_overview_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="under_request_overview_files/figure-html/cell-12-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="3f2f2239" class="cell" data-execution_count="381">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cell 6 – P4: Among ok_analysis == 1, under_request percent per journal</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Outputs TSV + PNG + PDF in 4.analyses/upon_request/under_request_pct_by_journal/.</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">"journal"</span> <span class="kw">not</span> <span class="kw">in</span> df.columns:</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Expected a 'journal' column in meta_under_request_tagged.tsv"</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>df_ok <span class="op">=</span> df[df[<span class="st">"ok_analysis_num"</span>] <span class="op">==</span> <span class="dv">1</span>].copy()</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>counts_j <span class="op">=</span> (</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    df_ok.groupby([<span class="st">"journal"</span>, <span class="st">"under_request_num"</span>], dropna<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>         .size()</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>         .reset_index(name<span class="op">=</span><span class="st">"n"</span>)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>pivot_j <span class="op">=</span> (</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    counts_j</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    .pivot(index<span class="op">=</span><span class="st">"journal"</span>, columns<span class="op">=</span><span class="st">"under_request_num"</span>, values<span class="op">=</span><span class="st">"n"</span>)</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    .fillna(<span class="dv">0</span>)</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="dv">0</span>: <span class="st">"not_ur"</span>, <span class="dv">1</span>: <span class="st">"ur"</span>})</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>pivot_j[<span class="st">"total"</span>] <span class="op">=</span> pivot_j[<span class="st">"not_ur"</span>] <span class="op">+</span> pivot_j[<span class="st">"ur"</span>]</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>pivot_j[<span class="st">"not_ur_pct"</span>] <span class="op">=</span> <span class="fl">100.0</span> <span class="op">*</span> pivot_j[<span class="st">"not_ur"</span>] <span class="op">/</span> pivot_j[<span class="st">"total"</span>].replace(<span class="dv">0</span>, np.nan)</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>pivot_j[<span class="st">"ur_pct"</span>] <span class="op">=</span> <span class="fl">100.0</span> <span class="op">*</span> pivot_j[<span class="st">"ur"</span>] <span class="op">/</span> pivot_j[<span class="st">"total"</span>].replace(<span class="dv">0</span>, np.nan)</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort journals by share of under_request == 1, then by total</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>pivot_j <span class="op">=</span> pivot_j.sort_values(</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>    by<span class="op">=</span>[<span class="st">"ur_pct"</span>, <span class="st">"total"</span>],</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>    ascending<span class="op">=</span>[<span class="va">False</span>, <span class="va">False</span>],</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>pivot_j_reset <span class="op">=</span> pivot_j.reset_index()</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>pivot_j_reset.to_csv(</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>    out_upon</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">/</span> <span class="st">"under_request_pct_by_journal"</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">/</span> <span class="st">"under_request_pct_by_journal.tsv"</span>,</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>    sep<span class="op">=</span><span class="st">"</span><span class="ch">\t</span><span class="st">"</span>,</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>pivot_j_reset.head()</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>fig_height <span class="op">=</span> <span class="bu">max</span>(<span class="dv">6</span>, <span class="fl">0.35</span> <span class="op">*</span> <span class="bu">len</span>(pivot_j_reset))</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, fig_height))</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.arange(<span class="bu">len</span>(pivot_j_reset))</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> pivot_j_reset[<span class="st">"journal"</span>]</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> pivot_j_reset[<span class="st">"not_ur_pct"</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>top <span class="op">=</span> pivot_j_reset[<span class="st">"ur_pct"</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>ax.barh(y, base, label<span class="op">=</span><span class="st">"under_request == 0"</span>)</span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>ax.barh(y, top, left<span class="op">=</span>base, label<span class="op">=</span><span class="st">"under_request == 1"</span>)</span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>ax.set_yticks(y)</span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>ax.set_yticklabels(labels)</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>ax.invert_yaxis()</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Percent of ok_analysis == 1"</span>)</span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Journal"</span>)</span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(<span class="dv">0</span>, <span class="dv">100</span>)</span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"‘Upon request’ among papers used in analysis by journal"</span>)</span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>ax.legend(frameon<span class="op">=</span><span class="va">False</span>, loc<span class="op">=</span><span class="st">"lower right"</span>)</span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>fig.savefig(</span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>    out_upon</span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>    <span class="op">/</span> <span class="st">"under_request_pct_by_journal"</span></span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>    <span class="op">/</span> <span class="st">"under_request_pct_by_journal.png"</span>,</span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a>    dpi<span class="op">=</span><span class="dv">300</span>,</span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a>fig.savefig(</span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a>    out_upon</span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a>    <span class="op">/</span> <span class="st">"under_request_pct_by_journal"</span></span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>    <span class="op">/</span> <span class="st">"under_request_pct_by_journal.pdf"</span>,</span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a>fig</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="381">
<div>
<figure class="figure">
<p><img src="under_request_overview_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="under_request_overview_files/figure-html/cell-13-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Journals differ markedly in their reliance on “upon request” language. For example, approximately 36 % of analysable Nature Communications articles contain a UR statement, versus less than 5 % in Genome Research</p>
</section>
</section>
<section id="genuine-versus-non-genuine-and-restricted-under-request-statements" class="level2">
<h2 class="anchored" data-anchor-id="genuine-versus-non-genuine-and-restricted-under-request-statements">4. Genuine versus non genuine and restricted “under request” statements</h2>
<p>Not all “data available upon request” statements are equal. Some correspond to real access routes to well documented datasets or materials, while others are vague and provide no verifiable sharing mechanism. In addition, a subset of statements explicitly describe restricted or controlled access regimes.</p>
<p>Using the <code>genuine</code> and <code>restricted</code> flags, we refine the global counts into three categories among <code>under_request == 1</code>:</p>
<ol type="1">
<li><strong>Genuine, non restricted</strong><br>
<code>genuine == 1</code> and <code>restricted == 0</code>. These statements typically:
<ul>
<li>refer to the availability of data in repositories plus an “also available upon request” clause, or</li>
<li>offer sharing of specific materials or code on reasonable request without additional legal barriers.</li>
</ul></li>
<li><strong>Restricted</strong><br>
<code>restricted == 1</code> (which always implies <code>genuine == 1</code>). These statements mention, for example:
<ul>
<li>signed data sharing agreements,</li>
<li>non disclosure agreements with hospitals or registries,</li>
<li>controlled access procedures, patient privacy or security constraints.</li>
</ul></li>
<li><strong>Non genuine</strong><br>
<code>genuine == 0</code> and <code>restricted == 0</code>. These cases often use “upon request” language in a way that does not clearly commit to data sharing, or refer to non data items such as non reproducible software environments.</li>
</ol>
<p>We visualise the breakdown by journal and by year using stacked barplots, showing:</p>
<ul>
<li>the proportion of all analysable articles that fall into each category, and</li>
<li>within the <code>under_request == 1</code> subset, the relative contributions of genuine, restricted, and non genuine statements.</li>
</ul>
<p>These plots show that a non trivial fraction of “upon request” statements are either ambiguous or describe restricted access regimes, which may significantly limit the practical reusability of the underlying data.</p>
<div id="27263fca" class="cell" data-execution_count="382">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># New Cell 1 – Load df with genuine numeric flag</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ensure_dir(p: Path) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    p.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Reload from disk using the same logic as load_df() in 10_plots_genuine_breakdown.py</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>df_g <span class="op">=</span> pd.read_csv(input_path, sep<span class="op">=</span><span class="st">"</span><span class="ch">\t</span><span class="st">"</span>, dtype<span class="op">=</span><span class="bu">str</span>, keep_default_na<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Required columns</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> [<span class="st">"year"</span>, <span class="st">"under_request"</span>, <span class="st">"genuine"</span>]:</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="kw">not</span> <span class="kw">in</span> df_g.columns:</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Expected column '</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">' in the input TSV."</span>)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalize types</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>df_g[<span class="st">"year"</span>] <span class="op">=</span> pd.to_numeric(df_g[<span class="st">"year"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>df_g[<span class="st">"under_request_num"</span>] <span class="op">=</span> (</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    pd.to_numeric(df_g[<span class="st">"under_request"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    .fillna(<span class="dv">0</span>)</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    .astype(<span class="bu">int</span>)</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>df_g[<span class="st">"genuine_num"</span>] <span class="op">=</span> (</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    pd.to_numeric(df_g[<span class="st">"genuine"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>    .fillna(<span class="dv">0</span>)</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    .astype(<span class="bu">int</span>)</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a><span class="co"># ok_analysis flag (same fallback order as in the script)</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">"ok_analysis"</span> <span class="kw">in</span> df_g.columns:</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>    df_g[<span class="st">"ok_analysis_num"</span>] <span class="op">=</span> (</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>        pd.to_numeric(df_g[<span class="st">"ok_analysis"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>        .fillna(<span class="dv">0</span>)</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>        .astype(<span class="bu">int</span>)</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a><span class="cf">elif</span> <span class="st">"analysis_ok"</span> <span class="kw">in</span> df_g.columns:</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>    df_g[<span class="st">"ok_analysis_num"</span>] <span class="op">=</span> (</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>        pd.to_numeric(df_g[<span class="st">"analysis_ok"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>        .fillna(<span class="dv">0</span>)</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>        .astype(<span class="bu">int</span>)</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>    df_g[<span class="st">"ok_analysis_num"</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop missing years and clip to analysis window</span></span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>df_g <span class="op">=</span> df_g.dropna(subset<span class="op">=</span>[<span class="st">"year"</span>]).copy()</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>df_g[<span class="st">"year"</span>] <span class="op">=</span> df_g[<span class="st">"year"</span>].astype(<span class="bu">int</span>)</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>df_g <span class="op">=</span> df_g[(df_g[<span class="st">"year"</span>] <span class="op">&gt;=</span> YEAR_MIN) <span class="op">&amp;</span> (df_g[<span class="st">"year"</span>] <span class="op">&lt;=</span> YEAR_MAX)].copy()</span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>df_g[[<span class="st">"year"</span>, <span class="st">"ok_analysis_num"</span>, <span class="st">"under_request_num"</span>, <span class="st">"genuine_num"</span>]].head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="382">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">ok_analysis_num</th>
<th data-quarto-table-cell-role="th">under_request_num</th>
<th data-quarto-table-cell-role="th">genuine_num</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2010</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2010</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2010</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2010</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>2010</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="1ac41b14" class="cell" data-execution_count="383">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># New Cell 2 – G2: Counts per year (not_UR vs UR &amp; g=0 vs UR &amp; g=1)</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>out_dir_counts <span class="op">=</span> out_upon <span class="op">/</span> <span class="st">"under_request_genuine"</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>ensure_dir(out_dir_counts)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>df_ok <span class="op">=</span> df_g[df_g[<span class="st">"ok_analysis_num"</span>] <span class="op">==</span> <span class="dv">1</span>].copy()</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Totals among ok_analysis==1</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>ok_total <span class="op">=</span> df_ok.groupby(<span class="st">"year"</span>).size().rename(<span class="st">"ok_analysis_1_total"</span>)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Breakdowns among ok_analysis==1</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>not_ur <span class="op">=</span> (</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    df_ok[df_ok[<span class="st">"under_request_num"</span>] <span class="op">==</span> <span class="dv">0</span>]</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"year"</span>)</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    .size()</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    .rename(<span class="st">"not_ur"</span>)</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>ur_g1 <span class="op">=</span> (</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>    df_ok[(df_ok[<span class="st">"under_request_num"</span>] <span class="op">==</span> <span class="dv">1</span>) <span class="op">&amp;</span> (df_ok[<span class="st">"genuine_num"</span>] <span class="op">==</span> <span class="dv">1</span>)]</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"year"</span>)</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>    .size()</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>    .rename(<span class="st">"ur_genuine_1"</span>)</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>ur_g0 <span class="op">=</span> (</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>    df_ok[(df_ok[<span class="st">"under_request_num"</span>] <span class="op">==</span> <span class="dv">1</span>) <span class="op">&amp;</span> (df_ok[<span class="st">"genuine_num"</span>] <span class="op">==</span> <span class="dv">0</span>)]</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"year"</span>)</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>    .size()</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>    .rename(<span class="st">"ur_genuine_0"</span>)</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>years <span class="op">=</span> pd.Series(<span class="bu">range</span>(YEAR_MIN, YEAR_MAX <span class="op">+</span> <span class="dv">1</span>), name<span class="op">=</span><span class="st">"year"</span>)</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>summary_g2 <span class="op">=</span> pd.DataFrame({<span class="st">"year"</span>: years})</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> s <span class="kw">in</span> (ok_total, not_ur, ur_g0, ur_g1):</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>    summary_g2 <span class="op">=</span> summary_g2.merge(s.reset_index(), on<span class="op">=</span><span class="st">"year"</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Fill + types</span></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> [<span class="st">"ok_analysis_1_total"</span>, <span class="st">"not_ur"</span>, <span class="st">"ur_genuine_0"</span>, <span class="st">"ur_genuine_1"</span>]:</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>    summary_g2[c] <span class="op">=</span> summary_g2[c].fillna(<span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Save TSV</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>summary_g2.to_csv(</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>    out_dir_counts <span class="op">/</span> <span class="st">"under_request_genuine_count_by_year.tsv"</span>,</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>    sep<span class="op">=</span><span class="st">"</span><span class="ch">\t</span><span class="st">"</span>,</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot (same structure as the script)</span></span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> summary_g2[<span class="st">"year"</span>].values</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> summary_g2[<span class="st">"not_ur"</span>].values</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>mid <span class="op">=</span> summary_g2[<span class="st">"ur_genuine_0"</span>].values</span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>top <span class="op">=</span> summary_g2[<span class="st">"ur_genuine_1"</span>].values</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>ax.bar(x, base, label<span class="op">=</span><span class="st">"ok_analysis==1 &amp; under_request==0"</span>)</span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>ax.bar(x, mid, bottom<span class="op">=</span>base, label<span class="op">=</span><span class="st">"UR &amp; genuine=0"</span>)</span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>ax.bar(x, top, bottom<span class="op">=</span>base <span class="op">+</span> mid, label<span class="op">=</span><span class="st">"UR &amp; genuine=1"</span>)</span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Year"</span>)</span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Number of papers (ok_analysis==1)"</span>)</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"ok_analysis==1 - Counts by year</span><span class="ch">\n</span><span class="st">(not_UR vs UR&amp;g=0 vs UR&amp;g=1)"</span>)</span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>ax.set_xticks(x)</span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>ax.set_xticklabels(x, rotation<span class="op">=</span><span class="dv">90</span>)</span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>ax.legend(frameon<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>fig.savefig(out_dir_counts <span class="op">/</span> <span class="st">"under_request_genuine_count_by_year.png"</span>, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a>fig.savefig(out_dir_counts <span class="op">/</span> <span class="st">"under_request_genuine_count_by_year.pdf"</span>)</span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a>plt.close(fig)</span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a>fig</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="383">
<div>
<figure class="figure">
<p><img src="under_request_overview_files/figure-html/cell-15-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Over time, the share of UR statements judged as genuine (with or without restrictions) increases, but a non-trivial fraction of UR language remains non-genuine or explicitly restricted in recent years</p>
<div id="82a3a388" class="cell" data-execution_count="384">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># New Cell 3 – G3: Percent per year (not_UR vs UR &amp; g=0 vs UR &amp; g=1)</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>out_dir_pct_year <span class="op">=</span> out_upon <span class="op">/</span> <span class="st">"under_request_genuine_pct_by_year"</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>ensure_dir(out_dir_pct_year)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>summary_g3 <span class="op">=</span> summary_g2.copy()</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>denom <span class="op">=</span> summary_g3[<span class="st">"ok_analysis_1_total"</span>].replace(<span class="dv">0</span>, np.nan)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>summary_g3[<span class="st">"not_ur_pct"</span>] <span class="op">=</span> <span class="fl">100.0</span> <span class="op">*</span> (summary_g3[<span class="st">"not_ur"</span>] <span class="op">/</span> denom)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>summary_g3[<span class="st">"ur_g0_pct"</span>] <span class="op">=</span> <span class="fl">100.0</span> <span class="op">*</span> (summary_g3[<span class="st">"ur_genuine_0"</span>] <span class="op">/</span> denom)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>summary_g3[<span class="st">"ur_g1_pct"</span>] <span class="op">=</span> <span class="fl">100.0</span> <span class="op">*</span> (summary_g3[<span class="st">"ur_genuine_1"</span>] <span class="op">/</span> denom)</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>summary_g3.to_csv(</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    out_dir_pct_year <span class="op">/</span> <span class="st">"under_request_genuine_pct_by_year.tsv"</span>,</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    sep<span class="op">=</span><span class="st">"</span><span class="ch">\t</span><span class="st">"</span>,</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> summary_g3[<span class="st">"year"</span>].values</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> summary_g3[<span class="st">"not_ur_pct"</span>].fillna(<span class="dv">0</span>).values</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> summary_g3[<span class="st">"ur_g0_pct"</span>].fillna(<span class="dv">0</span>).values</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> summary_g3[<span class="st">"ur_g1_pct"</span>].fillna(<span class="dv">0</span>).values</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>ax.bar(x, b, label<span class="op">=</span><span class="st">"not_UR (%)"</span>)</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>ax.bar(x, m, bottom<span class="op">=</span>b, label<span class="op">=</span><span class="st">"UR &amp; genuine=0 (%)"</span>)</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>ax.bar(x, t, bottom<span class="op">=</span>b <span class="op">+</span> m, label<span class="op">=</span><span class="st">"UR &amp; genuine=1 (%)"</span>)</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Year"</span>)</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Percent of ok_analysis==1"</span>)</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"ok_analysis==1 - Percent by year</span><span class="ch">\n</span><span class="st">(not_UR vs UR&amp;g=0 vs UR&amp;g=1)"</span>)</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>ax.set_xticks(x)</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>ax.set_xticklabels(x, rotation<span class="op">=</span><span class="dv">90</span>)</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(<span class="dv">0</span>, <span class="dv">100</span>)</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>ax.legend(frameon<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>fig.savefig(out_dir_pct_year <span class="op">/</span> <span class="st">"under_request_genuine_pct_by_year.png"</span>, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>fig.savefig(out_dir_pct_year <span class="op">/</span> <span class="st">"under_request_genuine_pct_by_year.pdf"</span>)</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>plt.close(fig)</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>fig </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="384">
<div>
<figure class="figure">
<p><img src="under_request_overview_files/figure-html/cell-16-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Over time, the share of UR statements judged as genuine (with or without restrictions) increases, but a non-trivial fraction of UR language remains non-genuine or explicitly restricted in recent years</p>
<div id="4dbbd88e" class="cell" data-execution_count="385">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># New Cell 4 – G4: Percent by journal (horizontal, sorted by total UR share)</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>out_dir_pct_journal <span class="op">=</span> out_upon <span class="op">/</span> <span class="st">"under_request_genuine_pct_by_journal"</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>ensure_dir(out_dir_pct_journal)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">"journal"</span> <span class="kw">not</span> <span class="kw">in</span> df_g.columns:</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Expected a 'journal' column in the input TSV."</span>)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>df_ok <span class="op">=</span> df_g[df_g[<span class="st">"ok_analysis_num"</span>] <span class="op">==</span> <span class="dv">1</span>].copy()</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>ok_total_j <span class="op">=</span> df_ok.groupby(<span class="st">"journal"</span>, dropna<span class="op">=</span><span class="va">False</span>).size().rename(<span class="st">"ok_analysis_1_total"</span>)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>not_ur_j <span class="op">=</span> (</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    df_ok[df_ok[<span class="st">"under_request_num"</span>] <span class="op">==</span> <span class="dv">0</span>]</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"journal"</span>, dropna<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    .size()</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    .rename(<span class="st">"not_ur"</span>)</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>ur_g1_j <span class="op">=</span> (</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    df_ok[(df_ok[<span class="st">"under_request_num"</span>] <span class="op">==</span> <span class="dv">1</span>) <span class="op">&amp;</span> (df_ok[<span class="st">"genuine_num"</span>] <span class="op">==</span> <span class="dv">1</span>)]</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"journal"</span>, dropna<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    .size()</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    .rename(<span class="st">"ur_genuine_1"</span>)</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>ur_g0_j <span class="op">=</span> (</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>    df_ok[(df_ok[<span class="st">"under_request_num"</span>] <span class="op">==</span> <span class="dv">1</span>) <span class="op">&amp;</span> (df_ok[<span class="st">"genuine_num"</span>] <span class="op">==</span> <span class="dv">0</span>)]</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"journal"</span>, dropna<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>    .size()</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>    .rename(<span class="st">"ur_genuine_0"</span>)</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>summary_j <span class="op">=</span> pd.concat([ok_total_j, not_ur_j, ur_g0_j, ur_g1_j], axis<span class="op">=</span><span class="dv">1</span>).fillna(<span class="dv">0</span>)</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> [<span class="st">"ok_analysis_1_total"</span>, <span class="st">"not_ur"</span>, <span class="st">"ur_genuine_0"</span>, <span class="st">"ur_genuine_1"</span>]:</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    summary_j[c] <span class="op">=</span> summary_j[c].astype(<span class="bu">int</span>)</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>denom_j <span class="op">=</span> summary_j[<span class="st">"ok_analysis_1_total"</span>].replace(<span class="dv">0</span>, np.nan)</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>summary_j[<span class="st">"not_ur_pct"</span>] <span class="op">=</span> <span class="fl">100.0</span> <span class="op">*</span> (summary_j[<span class="st">"not_ur"</span>] <span class="op">/</span> denom_j)</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>summary_j[<span class="st">"ur_g0_pct"</span>] <span class="op">=</span> <span class="fl">100.0</span> <span class="op">*</span> (summary_j[<span class="st">"ur_genuine_0"</span>] <span class="op">/</span> denom_j)</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>summary_j[<span class="st">"ur_g1_pct"</span>] <span class="op">=</span> <span class="fl">100.0</span> <span class="op">*</span> (summary_j[<span class="st">"ur_genuine_1"</span>] <span class="op">/</span> denom_j)</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>summary_j[<span class="st">"total_ur_pct"</span>] <span class="op">=</span> summary_j[<span class="st">"ur_g0_pct"</span>] <span class="op">+</span> summary_j[<span class="st">"ur_g1_pct"</span>]</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort by total UR share, then by total ok_analysis==1</span></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>summary_j <span class="op">=</span> summary_j.sort_values(</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>    by<span class="op">=</span>[<span class="st">"total_ur_pct"</span>, <span class="st">"ok_analysis_1_total"</span>],</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>    ascending<span class="op">=</span>[<span class="va">False</span>, <span class="va">False</span>],</span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>summary_j_reset <span class="op">=</span> summary_j.reset_index()  <span class="co"># restore journal as a column</span></span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>summary_j_reset.to_csv(</span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>    out_dir_pct_journal <span class="op">/</span> <span class="st">"under_request_genuine_pct_by_journal.tsv"</span>,</span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>    sep<span class="op">=</span><span class="st">"</span><span class="ch">\t</span><span class="st">"</span>,</span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a>fig_height <span class="op">=</span> <span class="bu">max</span>(<span class="dv">6</span>, <span class="fl">0.35</span> <span class="op">*</span> <span class="bu">len</span>(summary_j_reset))</span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, fig_height))</span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.arange(<span class="bu">len</span>(summary_j_reset))</span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> summary_j_reset[<span class="st">"journal"</span>].astype(<span class="bu">str</span>).values</span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a>b0 <span class="op">=</span> summary_j_reset[<span class="st">"not_ur_pct"</span>].fillna(<span class="dv">0</span>).values</span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a>b1 <span class="op">=</span> summary_j_reset[<span class="st">"ur_g0_pct"</span>].fillna(<span class="dv">0</span>).values</span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a>b2 <span class="op">=</span> summary_j_reset[<span class="st">"ur_g1_pct"</span>].fillna(<span class="dv">0</span>).values</span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a>ax.barh(y, b0, label<span class="op">=</span><span class="st">"not_UR (%)"</span>)</span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a>ax.barh(y, b1, left<span class="op">=</span>b0, label<span class="op">=</span><span class="st">"UR &amp; genuine=0 (%)"</span>)</span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a>ax.barh(y, b2, left<span class="op">=</span>b0 <span class="op">+</span> b1, label<span class="op">=</span><span class="st">"UR &amp; genuine=1 (%)"</span>)</span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a>ax.set_yticks(y)</span>
<span id="cb18-72"><a href="#cb18-72" aria-hidden="true" tabindex="-1"></a>ax.set_yticklabels(labels)</span>
<span id="cb18-73"><a href="#cb18-73" aria-hidden="true" tabindex="-1"></a>ax.invert_yaxis()</span>
<span id="cb18-74"><a href="#cb18-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-75"><a href="#cb18-75" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Percent of ok_analysis==1"</span>)</span>
<span id="cb18-76"><a href="#cb18-76" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Journal"</span>)</span>
<span id="cb18-77"><a href="#cb18-77" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"ok_analysis==1 - Percent by journal</span><span class="ch">\n</span><span class="st">(sorted by total ‘upon request’ share)"</span>)</span>
<span id="cb18-78"><a href="#cb18-78" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(<span class="dv">0</span>, <span class="dv">100</span>)</span>
<span id="cb18-79"><a href="#cb18-79" aria-hidden="true" tabindex="-1"></a>ax.legend(frameon<span class="op">=</span><span class="va">False</span>, loc<span class="op">=</span><span class="st">"lower right"</span>)</span>
<span id="cb18-80"><a href="#cb18-80" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb18-81"><a href="#cb18-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-82"><a href="#cb18-82" aria-hidden="true" tabindex="-1"></a>fig.savefig(out_dir_pct_journal <span class="op">/</span> <span class="st">"under_request_genuine_pct_by_journal.png"</span>, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb18-83"><a href="#cb18-83" aria-hidden="true" tabindex="-1"></a>fig.savefig(out_dir_pct_journal <span class="op">/</span> <span class="st">"under_request_genuine_pct_by_journal.pdf"</span>)</span>
<span id="cb18-84"><a href="#cb18-84" aria-hidden="true" tabindex="-1"></a>plt.close(fig)</span>
<span id="cb18-85"><a href="#cb18-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-86"><a href="#cb18-86" aria-hidden="true" tabindex="-1"></a>fig</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="385">
<div>
<figure class="figure">
<p><img src="under_request_overview_files/figure-html/cell-17-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="builds-the-under_request_by_journal-plots-so-it" class="level3">
<h3 class="anchored" data-anchor-id="builds-the-under_request_by_journal-plots-so-it">Builds the under_request_by_journal plot(s) so it:</h3>
<ul>
<li>Uses percent of ok_analysis == 1 (like your attached plot),</li>
<li>Also makes a raw count version,</li>
<li>Adds numeric labels on the bars,</li>
<li>Writes a single TSV with counts and percents,</li>
<li>Saves everything in 4.analyses/upon_request/under_request_by_journal.</li>
</ul>
<div id="6d3e12de" class="cell" data-execution_count="386">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ensure_dir(p: Path) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    p.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Output folder</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>out_dir_ubj <span class="op">=</span> out_upon <span class="op">/</span> <span class="st">"under_request_by_journal"</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>ensure_dir(out_dir_ubj)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Work on papers actually used in the analysis</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>df_ok <span class="op">=</span> df_g[df_g[<span class="st">"ok_analysis_num"</span>] <span class="op">==</span> <span class="dv">1</span>].copy()</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">"journal"</span> <span class="kw">not</span> <span class="kw">in</span> df_ok.columns:</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Expected a 'journal' column in the input TSV."</span>)</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Counts by journal and under_request flag</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>counts_j <span class="op">=</span> (</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    df_ok.groupby([<span class="st">"journal"</span>, <span class="st">"under_request_num"</span>], dropna<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>         .size()</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>         .reset_index(name<span class="op">=</span><span class="st">"n"</span>)</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Pivot to have one row per journal, columns: n_not_ur, n_ur</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>pivot_j <span class="op">=</span> (</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    counts_j</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    .pivot(index<span class="op">=</span><span class="st">"journal"</span>, columns<span class="op">=</span><span class="st">"under_request_num"</span>, values<span class="op">=</span><span class="st">"n"</span>)</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    .fillna(<span class="dv">0</span>)</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="dv">0</span>: <span class="st">"n_not_ur"</span>, <span class="dv">1</span>: <span class="st">"n_ur"</span>})</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Total ok_analysis == 1 per journal</span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>pivot_j[<span class="st">"n_total_ok"</span>] <span class="op">=</span> pivot_j[<span class="st">"n_not_ur"</span>] <span class="op">+</span> pivot_j[<span class="st">"n_ur"</span>]</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Percents relative to ok_analysis == 1 for that journal</span></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>denom <span class="op">=</span> pivot_j[<span class="st">"n_total_ok"</span>].replace(<span class="dv">0</span>, np.nan)</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>pivot_j[<span class="st">"not_ur_pct"</span>] <span class="op">=</span> <span class="fl">100.0</span> <span class="op">*</span> pivot_j[<span class="st">"n_not_ur"</span>] <span class="op">/</span> denom</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>pivot_j[<span class="st">"ur_pct"</span>] <span class="op">=</span> <span class="fl">100.0</span> <span class="op">*</span> pivot_j[<span class="st">"n_ur"</span>] <span class="op">/</span> denom</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort journals by UR percent, then by total number of papers</span></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>pivot_j <span class="op">=</span> pivot_j.sort_values(</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>    by<span class="op">=</span>[<span class="st">"ur_pct"</span>, <span class="st">"n_total_ok"</span>],</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>    ascending<span class="op">=</span>[<span class="va">False</span>, <span class="va">False</span>],</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>summary_ubj <span class="op">=</span> pivot_j.reset_index()  <span class="co"># restore journal column</span></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Save TSV with counts and percents</span></span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>summary_ubj.to_csv(</span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>    out_dir_ubj <span class="op">/</span> <span class="st">"under_request_by_journal.tsv"</span>,</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>    sep<span class="op">=</span><span class="st">"</span><span class="ch">\t</span><span class="st">"</span>,</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>summary_ubj.head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="386">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">under_request_num</th>
<th data-quarto-table-cell-role="th">journal</th>
<th data-quarto-table-cell-role="th">n_not_ur</th>
<th data-quarto-table-cell-role="th">n_ur</th>
<th data-quarto-table-cell-role="th">n_total_ok</th>
<th data-quarto-table-cell-role="th">not_ur_pct</th>
<th data-quarto-table-cell-role="th">ur_pct</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>Nature communications</td>
<td>26427</td>
<td>15196</td>
<td>41623</td>
<td>63.491339</td>
<td>36.508661</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>Cell</td>
<td>500</td>
<td>134</td>
<td>634</td>
<td>78.864353</td>
<td>21.135647</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>Nature</td>
<td>3368</td>
<td>875</td>
<td>4243</td>
<td>79.377799</td>
<td>20.622201</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>Nature medicine</td>
<td>843</td>
<td>197</td>
<td>1040</td>
<td>81.057692</td>
<td>18.942308</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>Cell genomics</td>
<td>311</td>
<td>44</td>
<td>355</td>
<td>87.605634</td>
<td>12.394366</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="plot-percent-stacked-barh-with-numbers" class="level3">
<h3 class="anchored" data-anchor-id="plot-percent-stacked-barh-with-numbers">Plot : percent stacked barh with numbers</h3>
<div id="888d579b" class="cell" data-execution_count="387">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>fig_height <span class="op">=</span> <span class="bu">max</span>(<span class="dv">6</span>, <span class="fl">0.35</span> <span class="op">*</span> <span class="bu">len</span>(summary_ubj))</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, fig_height))</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.arange(<span class="bu">len</span>(summary_ubj))</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> summary_ubj[<span class="st">"journal"</span>].astype(<span class="bu">str</span>).values</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>b0 <span class="op">=</span> summary_ubj[<span class="st">"not_ur_pct"</span>].fillna(<span class="dv">0</span>).values</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>b1 <span class="op">=</span> summary_ubj[<span class="st">"ur_pct"</span>].fillna(<span class="dv">0</span>).values</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>total_pct <span class="op">=</span> b0 <span class="op">+</span> b1  <span class="co"># should be 100 or close</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co"># under_request == 0 and == 1</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>bars_not_ur <span class="op">=</span> ax.barh(y, b0, label<span class="op">=</span><span class="st">"under_request == 0"</span>)</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>bars_ur <span class="op">=</span> ax.barh(y, b1, left<span class="op">=</span>b0, label<span class="op">=</span><span class="st">"under_request == 1"</span>)</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>ax.set_yticks(y)</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>ax.set_yticklabels(labels)</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>ax.invert_yaxis()</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Percent of ok_analysis == 1"</span>)</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Journal"</span>)</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"‘Upon request’ among papers used in analysis by journal"</span>)</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a><span class="co"># X limit slightly above max total percent</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>max_x <span class="op">=</span> <span class="bu">float</span>(np.nanmax(total_pct)) <span class="cf">if</span> <span class="bu">len</span>(total_pct) <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(<span class="dv">0</span>, <span class="bu">max</span>(<span class="fl">5.0</span>, max_x <span class="op">*</span> <span class="fl">1.05</span>))</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Add numbers at end of each bar: show counts, for example "UR=n_ur / total=n_total"</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, yy <span class="kw">in</span> <span class="bu">enumerate</span>(y):</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>    n_ur_i <span class="op">=</span> summary_ubj[<span class="st">"n_ur"</span>].iloc[i]</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    n_tot_i <span class="op">=</span> summary_ubj[<span class="st">"n_total_ok"</span>].iloc[i]</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>    pct_i <span class="op">=</span> total_pct[i]</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> np.isfinite(pct_i) <span class="kw">and</span> pct_i <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>        ax.text(</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>            pct_i <span class="op">+</span> max_x <span class="op">*</span> <span class="fl">0.06</span>,</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>            yy,</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"UR=</span><span class="sc">{</span>n_ur_i<span class="sc">}</span><span class="ss"> / </span><span class="sc">{</span>n_tot_i<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>            va<span class="op">=</span><span class="st">"center"</span>,</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>            ha<span class="op">=</span><span class="st">"left"</span>,</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>            fontsize<span class="op">=</span><span class="dv">8</span>,</span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>ax.legend(frameon<span class="op">=</span><span class="va">False</span>, loc<span class="op">=</span><span class="st">"lower right"</span>)</span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>fig.savefig(out_dir_ubj <span class="op">/</span> <span class="st">"under_request_by_journal_pct.png"</span>, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>fig.savefig(out_dir_ubj <span class="op">/</span> <span class="st">"under_request_by_journal_pct.pdf"</span>)</span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>plt.close(fig)</span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>fig</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="387">
<div>
<figure class="figure">
<p><img src="under_request_overview_files/figure-html/cell-19-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="plot-raw-counts-stacked-bar-same-order-with-numbers" class="level3">
<h3 class="anchored" data-anchor-id="plot-raw-counts-stacked-bar-same-order-with-numbers">Plot: raw counts stacked bar, same order, with numbers</h3>
<div id="c222b5c1" class="cell" data-execution_count="388">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>fig_height <span class="op">=</span> <span class="bu">max</span>(<span class="dv">6</span>, <span class="fl">0.35</span> <span class="op">*</span> <span class="bu">len</span>(summary_ubj))</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, fig_height))</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.arange(<span class="bu">len</span>(summary_ubj))</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> summary_ubj[<span class="st">"journal"</span>].astype(<span class="bu">str</span>).values</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>c0 <span class="op">=</span> summary_ubj[<span class="st">"n_not_ur"</span>].values</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>c1 <span class="op">=</span> summary_ubj[<span class="st">"n_ur"</span>].values</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>c_tot <span class="op">=</span> summary_ubj[<span class="st">"n_total_ok"</span>].values</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>bars_not_ur <span class="op">=</span> ax.barh(y, c0, label<span class="op">=</span><span class="st">"under_request == 0"</span>)</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>bars_ur <span class="op">=</span> ax.barh(y, c1, left<span class="op">=</span>c0, label<span class="op">=</span><span class="st">"under_request == 1"</span>)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>ax.set_yticks(y)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>ax.set_yticklabels(labels)</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>ax.invert_yaxis()</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Number of papers (ok_analysis == 1)"</span>)</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Journal"</span>)</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"‘Upon request’ among papers used in analysis by journal (counts)"</span>)</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>max_x_counts <span class="op">=</span> <span class="bu">float</span>(np.nanmax(c_tot)) <span class="cf">if</span> <span class="bu">len</span>(c_tot) <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(<span class="dv">0</span>, <span class="bu">max</span>(<span class="fl">5.0</span>, max_x_counts <span class="op">*</span> <span class="fl">1.05</span>))</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Add total counts at end of each bar</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, yy <span class="kw">in</span> <span class="bu">enumerate</span>(y):</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>    n_tot_i <span class="op">=</span> c_tot[i]</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>    right_edge <span class="op">=</span> c0[i] <span class="op">+</span> c1[i]</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> np.isfinite(right_edge) <span class="kw">and</span> right_edge <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>        ax.text(</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>            right_edge <span class="op">+</span> max_x_counts <span class="op">*</span> <span class="fl">0.01</span>,</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>            yy,</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"n=</span><span class="sc">{</span>n_tot_i<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>            va<span class="op">=</span><span class="st">"center"</span>,</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>            ha<span class="op">=</span><span class="st">"left"</span>,</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>            fontsize<span class="op">=</span><span class="dv">8</span>,</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>ax.legend(frameon<span class="op">=</span><span class="va">False</span>, loc<span class="op">=</span><span class="st">"lower right"</span>)</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>fig.savefig(out_dir_ubj <span class="op">/</span> <span class="st">"under_request_by_journal_counts.png"</span>, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>fig.savefig(out_dir_ubj <span class="op">/</span> <span class="st">"under_request_by_journal_counts.pdf"</span>)</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>plt.close(fig)</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>fig</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="388">
<div>
<figure class="figure">
<p><img src="under_request_overview_files/figure-html/cell-20-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Proportion of UR statementm by journal, with genuine info</p>
<div id="cb6878fd" class="cell" data-execution_count="389">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ensure_dir(p: Path) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    p.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Output folder for this plot</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>out_dir_ubj <span class="op">=</span> out_upon <span class="op">/</span> <span class="st">"under_request_by_journal"</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>ensure_dir(out_dir_ubj)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Work on the analysis subset (ok_analysis == 1), as in 10_plots_genuine_breakdown.py</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>df_ok <span class="op">=</span> df_g[df_g[<span class="st">"ok_analysis_num"</span>] <span class="op">==</span> <span class="dv">1</span>].copy()</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Total papers per journal</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>total_j <span class="op">=</span> df_ok.groupby(<span class="st">"journal"</span>, dropna<span class="op">=</span><span class="va">False</span>).size().rename(<span class="st">"n_total"</span>)</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="co"># All UR per journal</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>ur_total_j <span class="op">=</span> (</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    df_ok[df_ok[<span class="st">"under_request_num"</span>] <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"journal"</span>, dropna<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    .size()</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    .rename(<span class="st">"n_ur"</span>)</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a><span class="co"># UR &amp; genuine == 1 per journal</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>ur_g1_j <span class="op">=</span> (</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>    df_ok[(df_ok[<span class="st">"under_request_num"</span>] <span class="op">==</span> <span class="dv">1</span>) <span class="op">&amp;</span> (df_ok[<span class="st">"genuine_num"</span>] <span class="op">==</span> <span class="dv">1</span>)]</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"journal"</span>, dropna<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>    .size()</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>    .rename(<span class="st">"n_ur_genuine"</span>)</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine and derive UR &amp; genuine == 0</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>summary_ubj <span class="op">=</span> pd.concat([total_j, ur_total_j, ur_g1_j], axis<span class="op">=</span><span class="dv">1</span>).fillna(<span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>summary_ubj[<span class="st">"n_ur_g0"</span>] <span class="op">=</span> (summary_ubj[<span class="st">"n_ur"</span>] <span class="op">-</span> summary_ubj[<span class="st">"n_ur_genuine"</span>]).clip(lower<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Percent of *all papers* in that journal that are UR &amp; g=0 / UR &amp; g=1</span></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>denom <span class="op">=</span> summary_ubj[<span class="st">"n_total"</span>].replace(<span class="dv">0</span>, np.nan)</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>summary_ubj[<span class="st">"ur_g0_pct"</span>] <span class="op">=</span> <span class="fl">100.0</span> <span class="op">*</span> summary_ubj[<span class="st">"n_ur_g0"</span>] <span class="op">/</span> denom</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>summary_ubj[<span class="st">"ur_g1_pct"</span>] <span class="op">=</span> <span class="fl">100.0</span> <span class="op">*</span> summary_ubj[<span class="st">"n_ur_genuine"</span>] <span class="op">/</span> denom</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>summary_ubj[<span class="st">"ur_total_pct"</span>] <span class="op">=</span> summary_ubj[<span class="st">"ur_g0_pct"</span>] <span class="op">+</span> summary_ubj[<span class="st">"ur_g1_pct"</span>]</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort journals by total UR share (like the original under_request_by_journal plot)</span></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>summary_ubj <span class="op">=</span> summary_ubj.sort_values(<span class="st">"ur_total_pct"</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>summary_ubj_reset <span class="op">=</span> summary_ubj.reset_index()</span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Save TSV</span></span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>summary_ubj_reset.to_csv(</span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>    out_dir_ubj <span class="op">/</span> <span class="st">"under_request_by_journal_genuine.tsv"</span>,</span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>    sep<span class="op">=</span><span class="st">"</span><span class="ch">\t</span><span class="st">"</span>,</span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot: proportion of UR, split into genuine=0 vs genuine=1</span></span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>fig_height <span class="op">=</span> <span class="bu">max</span>(<span class="dv">6</span>, <span class="fl">0.35</span> <span class="op">*</span> <span class="bu">len</span>(summary_ubj_reset))</span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, fig_height))</span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.arange(<span class="bu">len</span>(summary_ubj_reset))</span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> summary_ubj_reset[<span class="st">"journal"</span>].astype(<span class="bu">str</span>).values</span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a><span class="co"># UR &amp; genuine = 0 (non-genuine UR)</span></span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a>b0 <span class="op">=</span> summary_ubj_reset[<span class="st">"ur_g0_pct"</span>].fillna(<span class="dv">0</span>).values</span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a><span class="co"># UR &amp; genuine = 1 (genuine UR)</span></span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a>b1 <span class="op">=</span> summary_ubj_reset[<span class="st">"ur_g1_pct"</span>].fillna(<span class="dv">0</span>).values</span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a><span class="co"># Colors:</span></span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a><span class="co">#   UR &amp; g=0  -&gt; orange (C1)</span></span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a><span class="co">#   UR &amp; g=1  -&gt; green (C2)</span></span>
<span id="cb22-69"><a href="#cb22-69" aria-hidden="true" tabindex="-1"></a>ax.barh(y, b0, label<span class="op">=</span><span class="st">"UR &amp; genuine = 0"</span>, color<span class="op">=</span><span class="st">"C1"</span>)</span>
<span id="cb22-70"><a href="#cb22-70" aria-hidden="true" tabindex="-1"></a>ax.barh(y, b1, left<span class="op">=</span>b0, label<span class="op">=</span><span class="st">"UR &amp; genuine = 1"</span>, color<span class="op">=</span><span class="st">"C2"</span>)</span>
<span id="cb22-71"><a href="#cb22-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-72"><a href="#cb22-72" aria-hidden="true" tabindex="-1"></a>ax.set_yticks(y)</span>
<span id="cb22-73"><a href="#cb22-73" aria-hidden="true" tabindex="-1"></a>ax.set_yticklabels(labels)</span>
<span id="cb22-74"><a href="#cb22-74" aria-hidden="true" tabindex="-1"></a>ax.invert_yaxis()</span>
<span id="cb22-75"><a href="#cb22-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-76"><a href="#cb22-76" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Percent of papers with 'under request' wording"</span>)</span>
<span id="cb22-77"><a href="#cb22-77" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Journal"</span>)</span>
<span id="cb22-78"><a href="#cb22-78" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Proportion of 'under request' statements per journal</span><span class="ch">\n</span><span class="st">broken down by genuine annotation"</span>)</span>
<span id="cb22-79"><a href="#cb22-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-80"><a href="#cb22-80" aria-hidden="true" tabindex="-1"></a><span class="co"># X-axis up to slightly above max UR share</span></span>
<span id="cb22-81"><a href="#cb22-81" aria-hidden="true" tabindex="-1"></a>max_x <span class="op">=</span> <span class="bu">float</span>(np.nanmax(summary_ubj_reset[<span class="st">"ur_total_pct"</span>])) <span class="cf">if</span> <span class="bu">len</span>(summary_ubj_reset) <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb22-82"><a href="#cb22-82" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(<span class="dv">0</span>, <span class="bu">max</span>(<span class="dv">5</span>, max_x <span class="op">*</span> <span class="fl">1.1</span>))</span>
<span id="cb22-83"><a href="#cb22-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-84"><a href="#cb22-84" aria-hidden="true" tabindex="-1"></a>ax.legend(frameon<span class="op">=</span><span class="va">False</span>, loc<span class="op">=</span><span class="st">"lower right"</span>)</span>
<span id="cb22-85"><a href="#cb22-85" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb22-86"><a href="#cb22-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-87"><a href="#cb22-87" aria-hidden="true" tabindex="-1"></a>fig.savefig(out_dir_ubj <span class="op">/</span> <span class="st">"under_request_by_journal_genuine.png"</span>, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb22-88"><a href="#cb22-88" aria-hidden="true" tabindex="-1"></a>fig.savefig(out_dir_ubj <span class="op">/</span> <span class="st">"under_request_by_journal_genuine.pdf"</span>)</span>
<span id="cb22-89"><a href="#cb22-89" aria-hidden="true" tabindex="-1"></a>plt.close(fig)</span>
<span id="cb22-90"><a href="#cb22-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-91"><a href="#cb22-91" aria-hidden="true" tabindex="-1"></a>fig</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="389">
<div>
<figure class="figure">
<p><img src="under_request_overview_files/figure-html/cell-21-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="a-tsv-with-full-counts-and-percentages-per-journal-including-the-restricted-subset." class="level3">
<h3 class="anchored" data-anchor-id="a-tsv-with-full-counts-and-percentages-per-journal-including-the-restricted-subset.">A TSV with full counts and percentages per journal, including the restricted subset.</h3>
<p>A bar plot where:</p>
<ul>
<li>Each bar length is the total percent of papers with UR in that journal.</li>
<li>The bar is split into:</li>
<li>UR &amp; genuine = 0 (orange),</li>
<li>UR &amp; genuine = 1, not restricted (green),</li>
<li>UR &amp; restricted = 1 (red).</li>
</ul>
<p>The label n=… at the right of each bar shows the total number of UR papers in that journal.</p>
<div id="87fffd42" class="cell" data-execution_count="390">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ensure_dir(p: Path) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    p.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Output folder</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>out_dir_ubj <span class="op">=</span> out_upon <span class="op">/</span> <span class="st">"under_request_by_journal"</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>ensure_dir(out_dir_ubj)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Make sure restricted_num exists</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">"restricted"</span> <span class="kw">in</span> df_g.columns:</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    df_g[<span class="st">"restricted_num"</span>] <span class="op">=</span> (</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>        pd.to_numeric(df_g[<span class="st">"restricted"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>        .fillna(<span class="dv">0</span>)</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>        .astype(<span class="bu">int</span>)</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    df_g[<span class="st">"restricted_num"</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Restrict to ok_analysis == 1, like in the other plots</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>df_ok <span class="op">=</span> df_g[df_g[<span class="st">"ok_analysis_num"</span>] <span class="op">==</span> <span class="dv">1</span>].copy()</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Totals per journal</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>total_j <span class="op">=</span> df_ok.groupby(<span class="st">"journal"</span>, dropna<span class="op">=</span><span class="va">False</span>).size().rename(<span class="st">"n_total"</span>)</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a><span class="co"># UR totals</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>ur_total_j <span class="op">=</span> (</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>    df_ok[df_ok[<span class="st">"under_request_num"</span>] <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"journal"</span>, dropna<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>    .size()</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>    .rename(<span class="st">"n_ur"</span>)</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a><span class="co"># UR &amp; genuine == 1</span></span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>ur_g1_j <span class="op">=</span> (</span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>    df_ok[(df_ok[<span class="st">"under_request_num"</span>] <span class="op">==</span> <span class="dv">1</span>) <span class="op">&amp;</span> (df_ok[<span class="st">"genuine_num"</span>] <span class="op">==</span> <span class="dv">1</span>)]</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"journal"</span>, dropna<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>    .size()</span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>    .rename(<span class="st">"n_ur_genuine"</span>)</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a><span class="co"># UR &amp; restricted == 1 (subset of genuine)</span></span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>ur_restricted_j <span class="op">=</span> (</span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>    df_ok[(df_ok[<span class="st">"under_request_num"</span>] <span class="op">==</span> <span class="dv">1</span>) <span class="op">&amp;</span> (df_ok[<span class="st">"restricted_num"</span>] <span class="op">==</span> <span class="dv">1</span>)]</span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"journal"</span>, dropna<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a>    .size()</span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>    .rename(<span class="st">"n_ur_restricted"</span>)</span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine</span></span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a>summary_ubj <span class="op">=</span> pd.concat(</span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>    [total_j, ur_total_j, ur_g1_j, ur_restricted_j],</span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a>    axis<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a>).fillna(<span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a><span class="co"># UR &amp; genuine == 0</span></span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a>summary_ubj[<span class="st">"n_ur_g0"</span>] <span class="op">=</span> (</span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a>    summary_ubj[<span class="st">"n_ur"</span>] <span class="op">-</span> summary_ubj[<span class="st">"n_ur_genuine"</span>]</span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a>).clip(lower<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a><span class="co"># UR &amp; genuine == 1 but NOT restricted</span></span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a>summary_ubj[<span class="st">"n_ur_genuine_only"</span>] <span class="op">=</span> (</span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a>    summary_ubj[<span class="st">"n_ur_genuine"</span>] <span class="op">-</span> summary_ubj[<span class="st">"n_ur_restricted"</span>]</span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a>).clip(lower<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a><span class="co"># Percent of ALL papers in that journal that are UR of each type</span></span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a>denom <span class="op">=</span> summary_ubj[<span class="st">"n_total"</span>].replace(<span class="dv">0</span>, np.nan)</span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-70"><a href="#cb23-70" aria-hidden="true" tabindex="-1"></a>summary_ubj[<span class="st">"ur_g0_pct"</span>] <span class="op">=</span> <span class="fl">100.0</span> <span class="op">*</span> summary_ubj[<span class="st">"n_ur_g0"</span>] <span class="op">/</span> denom</span>
<span id="cb23-71"><a href="#cb23-71" aria-hidden="true" tabindex="-1"></a>summary_ubj[<span class="st">"ur_genuine_only_pct"</span>] <span class="op">=</span> <span class="fl">100.0</span> <span class="op">*</span> summary_ubj[<span class="st">"n_ur_genuine_only"</span>] <span class="op">/</span> denom</span>
<span id="cb23-72"><a href="#cb23-72" aria-hidden="true" tabindex="-1"></a>summary_ubj[<span class="st">"ur_restricted_pct"</span>] <span class="op">=</span> <span class="fl">100.0</span> <span class="op">*</span> summary_ubj[<span class="st">"n_ur_restricted"</span>] <span class="op">/</span> denom</span>
<span id="cb23-73"><a href="#cb23-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-74"><a href="#cb23-74" aria-hidden="true" tabindex="-1"></a>summary_ubj[<span class="st">"ur_total_pct"</span>] <span class="op">=</span> (</span>
<span id="cb23-75"><a href="#cb23-75" aria-hidden="true" tabindex="-1"></a>    summary_ubj[<span class="st">"ur_g0_pct"</span>]</span>
<span id="cb23-76"><a href="#cb23-76" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> summary_ubj[<span class="st">"ur_genuine_only_pct"</span>]</span>
<span id="cb23-77"><a href="#cb23-77" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> summary_ubj[<span class="st">"ur_restricted_pct"</span>]</span>
<span id="cb23-78"><a href="#cb23-78" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-79"><a href="#cb23-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-80"><a href="#cb23-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort journals by total UR share, then by total papers</span></span>
<span id="cb23-81"><a href="#cb23-81" aria-hidden="true" tabindex="-1"></a>summary_ubj <span class="op">=</span> summary_ubj.sort_values(</span>
<span id="cb23-82"><a href="#cb23-82" aria-hidden="true" tabindex="-1"></a>    by<span class="op">=</span>[<span class="st">"ur_total_pct"</span>, <span class="st">"n_total"</span>],</span>
<span id="cb23-83"><a href="#cb23-83" aria-hidden="true" tabindex="-1"></a>    ascending<span class="op">=</span>[<span class="va">False</span>, <span class="va">False</span>],</span>
<span id="cb23-84"><a href="#cb23-84" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-85"><a href="#cb23-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-86"><a href="#cb23-86" aria-hidden="true" tabindex="-1"></a>summary_ubj_reset <span class="op">=</span> summary_ubj.reset_index()  <span class="co"># restore journal column</span></span>
<span id="cb23-87"><a href="#cb23-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-88"><a href="#cb23-88" aria-hidden="true" tabindex="-1"></a><span class="co"># Save TSV</span></span>
<span id="cb23-89"><a href="#cb23-89" aria-hidden="true" tabindex="-1"></a>summary_ubj_reset.to_csv(</span>
<span id="cb23-90"><a href="#cb23-90" aria-hidden="true" tabindex="-1"></a>    out_dir_ubj <span class="op">/</span> <span class="st">"under_request_by_journal_genuine_restricted.tsv"</span>,</span>
<span id="cb23-91"><a href="#cb23-91" aria-hidden="true" tabindex="-1"></a>    sep<span class="op">=</span><span class="st">"</span><span class="ch">\t</span><span class="st">"</span>,</span>
<span id="cb23-92"><a href="#cb23-92" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb23-93"><a href="#cb23-93" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-94"><a href="#cb23-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-95"><a href="#cb23-95" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb23-96"><a href="#cb23-96" aria-hidden="true" tabindex="-1"></a>fig_height <span class="op">=</span> <span class="bu">max</span>(<span class="dv">6</span>, <span class="fl">0.35</span> <span class="op">*</span> <span class="bu">len</span>(summary_ubj_reset))</span>
<span id="cb23-97"><a href="#cb23-97" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, fig_height))</span>
<span id="cb23-98"><a href="#cb23-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-99"><a href="#cb23-99" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.arange(<span class="bu">len</span>(summary_ubj_reset))</span>
<span id="cb23-100"><a href="#cb23-100" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> summary_ubj_reset[<span class="st">"journal"</span>].astype(<span class="bu">str</span>).values</span>
<span id="cb23-101"><a href="#cb23-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-102"><a href="#cb23-102" aria-hidden="true" tabindex="-1"></a>b0 <span class="op">=</span> summary_ubj_reset[<span class="st">"ur_g0_pct"</span>].fillna(<span class="dv">0</span>).values</span>
<span id="cb23-103"><a href="#cb23-103" aria-hidden="true" tabindex="-1"></a>b1 <span class="op">=</span> summary_ubj_reset[<span class="st">"ur_genuine_only_pct"</span>].fillna(<span class="dv">0</span>).values</span>
<span id="cb23-104"><a href="#cb23-104" aria-hidden="true" tabindex="-1"></a>b2 <span class="op">=</span> summary_ubj_reset[<span class="st">"ur_restricted_pct"</span>].fillna(<span class="dv">0</span>).values</span>
<span id="cb23-105"><a href="#cb23-105" aria-hidden="true" tabindex="-1"></a>total_pct <span class="op">=</span> summary_ubj_reset[<span class="st">"ur_total_pct"</span>].fillna(<span class="dv">0</span>).values</span>
<span id="cb23-106"><a href="#cb23-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-107"><a href="#cb23-107" aria-hidden="true" tabindex="-1"></a><span class="co"># Colors:</span></span>
<span id="cb23-108"><a href="#cb23-108" aria-hidden="true" tabindex="-1"></a><span class="co">#   UR &amp; g=0           -&gt; orange (C1)</span></span>
<span id="cb23-109"><a href="#cb23-109" aria-hidden="true" tabindex="-1"></a><span class="co">#   UR &amp; g=1, not restr -&gt; green (C2)</span></span>
<span id="cb23-110"><a href="#cb23-110" aria-hidden="true" tabindex="-1"></a><span class="co">#   UR &amp; restricted    -&gt; red (C3)</span></span>
<span id="cb23-111"><a href="#cb23-111" aria-hidden="true" tabindex="-1"></a>ax.barh(y, b0, label<span class="op">=</span><span class="st">"UR &amp; genuine = 0"</span>, color<span class="op">=</span><span class="st">"C1"</span>)</span>
<span id="cb23-112"><a href="#cb23-112" aria-hidden="true" tabindex="-1"></a>ax.barh(y, b1, left<span class="op">=</span>b0, label<span class="op">=</span><span class="st">"UR &amp; genuine = 1, not restricted"</span>, color<span class="op">=</span><span class="st">"C2"</span>)</span>
<span id="cb23-113"><a href="#cb23-113" aria-hidden="true" tabindex="-1"></a>ax.barh(</span>
<span id="cb23-114"><a href="#cb23-114" aria-hidden="true" tabindex="-1"></a>    y,</span>
<span id="cb23-115"><a href="#cb23-115" aria-hidden="true" tabindex="-1"></a>    b2,</span>
<span id="cb23-116"><a href="#cb23-116" aria-hidden="true" tabindex="-1"></a>    left<span class="op">=</span>b0 <span class="op">+</span> b1,</span>
<span id="cb23-117"><a href="#cb23-117" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span><span class="st">"UR &amp; restricted = 1"</span>,</span>
<span id="cb23-118"><a href="#cb23-118" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"C3"</span>,</span>
<span id="cb23-119"><a href="#cb23-119" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-120"><a href="#cb23-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-121"><a href="#cb23-121" aria-hidden="true" tabindex="-1"></a>ax.set_yticks(y)</span>
<span id="cb23-122"><a href="#cb23-122" aria-hidden="true" tabindex="-1"></a>ax.set_yticklabels(labels)</span>
<span id="cb23-123"><a href="#cb23-123" aria-hidden="true" tabindex="-1"></a>ax.invert_yaxis()</span>
<span id="cb23-124"><a href="#cb23-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-125"><a href="#cb23-125" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Percent of papers with any 'under request' wording"</span>)</span>
<span id="cb23-126"><a href="#cb23-126" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Journal"</span>)</span>
<span id="cb23-127"><a href="#cb23-127" aria-hidden="true" tabindex="-1"></a>ax.set_title(</span>
<span id="cb23-128"><a href="#cb23-128" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Proportion of 'under request' statements per journal</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb23-129"><a href="#cb23-129" aria-hidden="true" tabindex="-1"></a>    <span class="st">"split into non genuine, genuine non restricted, and restricted"</span></span>
<span id="cb23-130"><a href="#cb23-130" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-131"><a href="#cb23-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-132"><a href="#cb23-132" aria-hidden="true" tabindex="-1"></a>max_x <span class="op">=</span> <span class="bu">float</span>(np.nanmax(total_pct)) <span class="cf">if</span> <span class="bu">len</span>(total_pct) <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb23-133"><a href="#cb23-133" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(<span class="dv">0</span>, <span class="bu">max</span>(<span class="fl">5.0</span>, max_x <span class="op">*</span> <span class="fl">1.15</span>))</span>
<span id="cb23-134"><a href="#cb23-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-135"><a href="#cb23-135" aria-hidden="true" tabindex="-1"></a><span class="co"># Add total UR counts at the end of each bar</span></span>
<span id="cb23-136"><a href="#cb23-136" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (pct, yy) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(total_pct, y)):</span>
<span id="cb23-137"><a href="#cb23-137" aria-hidden="true" tabindex="-1"></a>    n_ur_i <span class="op">=</span> summary_ubj_reset[<span class="st">"n_ur"</span>].iloc[i]</span>
<span id="cb23-138"><a href="#cb23-138" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> np.isfinite(pct) <span class="kw">and</span> pct <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb23-139"><a href="#cb23-139" aria-hidden="true" tabindex="-1"></a>        ax.text(</span>
<span id="cb23-140"><a href="#cb23-140" aria-hidden="true" tabindex="-1"></a>            pct <span class="op">+</span> max_x <span class="op">*</span> <span class="fl">0.01</span>,</span>
<span id="cb23-141"><a href="#cb23-141" aria-hidden="true" tabindex="-1"></a>            yy,</span>
<span id="cb23-142"><a href="#cb23-142" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"n=</span><span class="sc">{</span>n_ur_i<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb23-143"><a href="#cb23-143" aria-hidden="true" tabindex="-1"></a>            va<span class="op">=</span><span class="st">"center"</span>,</span>
<span id="cb23-144"><a href="#cb23-144" aria-hidden="true" tabindex="-1"></a>            ha<span class="op">=</span><span class="st">"left"</span>,</span>
<span id="cb23-145"><a href="#cb23-145" aria-hidden="true" tabindex="-1"></a>            fontsize<span class="op">=</span><span class="dv">8</span>,</span>
<span id="cb23-146"><a href="#cb23-146" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-147"><a href="#cb23-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-148"><a href="#cb23-148" aria-hidden="true" tabindex="-1"></a>ax.legend(frameon<span class="op">=</span><span class="va">False</span>, loc<span class="op">=</span><span class="st">"lower right"</span>)</span>
<span id="cb23-149"><a href="#cb23-149" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb23-150"><a href="#cb23-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-151"><a href="#cb23-151" aria-hidden="true" tabindex="-1"></a>fig.savefig(out_dir_ubj <span class="op">/</span> <span class="st">"under_request_by_journal_genuine_restricted.png"</span>, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb23-152"><a href="#cb23-152" aria-hidden="true" tabindex="-1"></a>fig.savefig(out_dir_ubj <span class="op">/</span> <span class="st">"under_request_by_journal_genuine_restricted.pdf"</span>)</span>
<span id="cb23-153"><a href="#cb23-153" aria-hidden="true" tabindex="-1"></a>plt.close(fig)</span>
<span id="cb23-154"><a href="#cb23-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-155"><a href="#cb23-155" aria-hidden="true" tabindex="-1"></a>fig</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="390">
<div>
<figure class="figure">
<p><img src="under_request_overview_files/figure-html/cell-22-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="reproducibility-and-exported-outputs" class="level2">
<h2 class="anchored" data-anchor-id="reproducibility-and-exported-outputs">6. Reproducibility and exported outputs</h2>
<p>All analyses in this notebook are based on the metadata table <code>meta_under_request_tagged.tsv</code> generated by the main text mining pipeline. To make the results reproducible:</p>
<ul>
<li>Every plot is written to disk as both PDF and PNG files in the <code>4.analyses/upon_request</code> subdirectories.</li>
<li>The underlying summary tables used to generate each figure (for example, counts and percentages by year and journal) are exported as TSV files alongside the plots.</li>
<li>The classification logic for <code>under_request</code>, <code>genuine</code>, and <code>restricted</code> is captured in the scripts <code>07_parse_under_request_with_sections_restricted.py</code> and <code>08_tag_under_request_compliance.py</code>, which are version controlled in the <code>1.scripts</code> folder.</li>
</ul>
<p>This notebook, together with the scripts and TSV outputs, provide a transparent and inspectable record of the analyses underlying the figures used in the main text and supplementary material.</p>
<p>The current notebook and the scripts <code>07_parse_under_request_with_sections_restricted.py</code> and <code>08_tag_under_request_compliance.py</code> are version-controlled in the <code>1.scripts</code> directory and archived together with the TSV outputs in Zenodo and the institutional code archive.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>